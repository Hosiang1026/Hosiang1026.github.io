<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="Access-Control-Allow-Origin" content="*"><script type="text/javascript">var start_time=(new Date).getTime()</script><meta http-equiv="Cache-Control" content="no-cache"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="google-site-verification" content="9Wt3lmnrT2bfjaHla5s16adhvcQcBHO7PtNf97n5Od0"><meta name="baidu-site-verification" content="RYlYHsgO7Y"><meta name="sogou_site_verification" content="MSmrTj7lHV"><meta name="shenma-site-verification" content="e4428ccce0f22fad61c3716193bf4bd7_1571416388"><meta name="baidu_union_verify" content="584bb6b4bd24108df082b6d20c7aa9be"><title>推荐系列-Helm Charts 开发完整示例 | 狂欢马克思</title><meta name="keywords" content="分享技术经验与交流"><meta name="description" content="&amp;emsp;&amp;emsp;lm 的使用是比较简单的，但是要让我们自己开发一个 Chart 包还是有不小难度的，主要还是 go template 的语法规则不够人性化，这里我们用一个完整的实例来演示下如何开发一个 Helm Chart 包…"><meta property="og:type" content="article"><meta property="og:title" content="推荐系列-Helm Charts 开发完整示例"><meta property="og:url" content="https://www.hosiang.cn/63833af1/index.html"><meta property="og:site_name" content="狂欢马克思"><meta property="og:description" content="&amp;emsp;&amp;emsp;lm 的使用是比较简单的，但是要让我们自己开发一个 Chart 包还是有不小难度的，主要还是 go template 的语法规则不够人性化，这里我们用一个完整的实例来演示下如何开发一个 Helm Chart 包…"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2022-03-27T03:56:25.000Z"><meta property="article:modified_time" content="2022-05-11T09:37:14.667Z"><meta property="article:author" content="Howe Hsiang"><meta property="article:tag" content="Popular"><meta name="twitter:card" content="summary"><link rel="icon" href="/images/favicon.ico"><link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"><link href="https://cdn.bootcss.com/font-awesome-animation/0.1.0/font-awesome-animation.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/style.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?3cd8fa109426bf3f10bd5c362175bace";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script></script><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><meta name="generator" content="Hexo 6.2.0"></head><script src="/js/jquery.min.js"></script><script src="/js/pace.min.js"></script><script src="/js/crypto-js.js"></script><script src="/js/cookie.js"></script><script src="/js/calendar.js"></script><script src="/js/festival.js"></script><script>getFestival()</script><body><script>window.onload=function(){document.getElementById("TimeShow").innerHTML="本站耗时 "+((new Date).getTime()-start_time)/1e3+" 秒 "}</script><div id="container"><header id="header"><div id="banner"></div><div id="header-outer"><div id="header-menu" class="header-menu-pos animated"><div class="header-menu-container"><a href="/" class="left"><span class="site-title">狂欢马克思</span></a><nav id="header-menu-nav" class="right"><a href="/" rel="external nofollow"><i class="fa fa-home"></i> <span>主页</span> </a><a href="/archives" rel="external nofollow"><i class="fa fa-archive"></i> <span>归档</span> </a><a href="/gitbook" rel="external nofollow"><i class="fa fa-columns"></i> <span>笔记</span> </a><a href="/music" rel="external nofollow"><i class="fa fa-music"></i> <span>音乐</span> </a><a href="/photo" rel="external nofollow"><i class="fa fa-picture-o"></i> <span>相册</span> </a><a href="/collection" rel="external nofollow"><i class="fa fa-envira"></i> <span>收藏</span> </a><a href="/about" rel="external nofollow"><i class="fa fa-user"></i> <span>关于</span></a></nav><a class="mobile-header-menu-button"><i class="fa fa-bars"></i></a></div></div><div id="header-row"><div id="logo"><a href="/"><img src="/../images/logo.png" alt="logo"></a></div><div class="header-info"><div id="header-title"><h2>狂欢马克思</h2></div><div id="header-description"><h3>专注Web开发</h3></div></div><nav class="header-nav"><div class="social"><a title="Github" target="_blank" href="//github.com/Hosiang1026" rel="external nofollow"><i class="fa fa-github fa-2x"></i></a> <a title="QQ" target="_blank" href="//wpa.qq.com/msgrd?v=3&uin=641904695&site=qq&menu=yes" rel="external nofollow"><i class="fa fa-qq fa-2x"></i></a> <a title="Weibo" target="_blank" href="//www.weibo.com/haoxiang969" rel="external nofollow"><i class="fa fa-weibo fa-2x"></i></a></div></nav></div><div id="noticeId" class="show" style="background:rgb(244,247,247,.3)"><marquee id="noticeMar" behavior="scoll" class="notice" direction="left" onmouseover="this.stop()" onmouseout="this.start()"></marquee></div><script type="text/javascript">function browserRedirect(){var i=navigator.userAgent.toLowerCase(),n="ipad"==i.match(/ipad/i),o="iphone os"==i.match(/iphone os/i),a="midp"==i.match(/midp/i),t="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),e="ucweb"==i.match(/ucweb/i),s="android"==i.match(/android/i),d="windows ce"==i.match(/windows ce/i),p="windows mobile"==i.match(/windows mobile/i),r="",c=randomColor(),r=n||o||a||t||e||s||d||p?($("#noticeId").css({"line-height":"1.6em"}),"<font style='color:"+c+"' face='新华宋体'  size='2'>官宣：<span id='weekend'></span><span id='msg'></span><span id='timer'></span><span id='hitokoto'></span></span></span><span id='YQData'></font> "):($("#noticeId").css({"line-height":"3.6em","margin-top":"20px"}),"<font style='color:"+c+"' face='新华宋体'  size='6'>官宣：<span id='weekend'></span><span id='msg'></span><span id='timer'></span><span id='hitokoto'></span></span><span id='YQData'></span></font> ");$("#noticeMar").html(r)}function randomColor(){for(var i="0,1,2,3,4,5,6,7,8,9,a,b,c,d,e,f".split(","),n="#",o=0;o<6;o++)n+=i[Math.floor(16*Math.random())];return n}$(function(){browserRedirect(),0<$("#hitokoto").length&&getHitokoto()})</script></div></header><script>console.log=function(){}</script><div class="outer"><section id="main" class="body-wrap"><article id="post-Helm Charts 开发完整示例" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 class="post-title" itemprop="name">推荐系列-Helm Charts 开发完整示例</h1><div class="post-title-bar"><ul><li><i class="fa fa-book"></i> <a href="/categories/热门文章/">热门文章</a></li><li><i class="fa fa-calendar"></i> 2022-03-27</li><li><i class="fa fa-eye"></i> <span id="busuanzi_value_page_pv"></span></li><li><span class="post-count">字数统计: 6.4k字</span></li><li><span class="post-count">阅读时长: 32分钟</span></li></ul></div></header><div class="article-entry post-content" itemprop="articleBody"><p>&amp;emsp;&amp;emsp;lm 的使用是比较简单的，但是要让我们自己开发一个 Chart 包还是有不小难度的，主要还是 go template 的语法规则不够人性化，这里我们用一个完整的实例来演示下如何开发一个 Helm Chart 包…</p><span id="more"></span><h4 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h4><p>我们这里以 Ghost 博客应用为例来演示如何开发一个完整的 Helm Chart 包，Ghost 是基于 Node.js 的开源博客平台。在开发 Helm Chart 包之前我们最需要做的的就是要知道我们自己的应用应该如何使用、如何部署，不然是不可能编写出对应的 Chart 包的。<br>启动 Ghost 最简单的方式是直接使用镜像启动：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜ docker run -d --name my-ghost -p <span class="number">2368</span>:<span class="number">2368</span> ghost</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>然后我们就可以通过 <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//localhost:2368</span></span><br></pre></td></tr></table></figure><br> 访问 Ghost 博客了。如果我们想要在 Kubernetes 集群中部署两个副本的 Ghost，可以直接应用下面的资源清单文件即可：<p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">  # ghost/deployment.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: ghost</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: ghost-app</span><br><span class="line">  replicas: <span class="number">2</span></span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: ghost-app</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: ghost-app</span><br><span class="line">          image: ghost</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: <span class="number">2368</span></span><br><span class="line">---</span><br><span class="line"># ghost/service.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: ghost</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  selector:</span><br><span class="line">    app: ghost-app</span><br><span class="line">  ports:</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      port: <span class="number">80</span></span><br><span class="line">      targetPort: <span class="number">2368</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>直接通过 kubectl 应用上面的资源对象即可：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  ➜ kubectl apply -f ghost/deployment.yaml ghost/service.yaml</span><br><span class="line">deployment.apps/ghost created</span><br><span class="line">service/ghost created</span><br><span class="line">➜ kubectl get pod -l app=ghost-app</span><br><span class="line">NAME                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">ghost-dfd958cc9-4s9b9   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          2m54s</span><br><span class="line">ghost-dfd958cc9-84kmv   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          2m54s</span><br><span class="line">➜ kubectl get svc ghost</span><br><span class="line">NAME    TYPE       CLUSTER-IP      EXTERNAL-IP   <span class="title function_">PORT</span><span class="params">(S)</span>        AGE</span><br><span class="line">ghost   NodePort   <span class="number">10.97</span><span class="number">.227</span><span class="number">.160</span>   &lt;none&gt;        <span class="number">80</span>:<span class="number">31950</span>/TCP   3m33s</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这样我们就可以通过 <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//&lt;nodeip&gt;:31950</span></span><br></pre></td></tr></table></figure><br> 访问到 Ghost 了：<p></p><p>ghost<br>看上去要部署 Ghost 是非常简单的，但是如果我们需要针对不同的环境进行不同的设置呢？比如我们想将它部署到不同环境（staging、prod）中去，是不是我们需要一遍又一遍地复制我们的 Kubernetes 资源清单文件，这��只是一个场景，还有很多场景可能需要我们去部署应用，这种方式维护起来是非常困难的，这个时候就可以理由 Helm 来解放我们了。</p><h4 id="基础模板"><a href="#基础模板" class="headerlink" title="基础模板"></a>基础模板</h4><p>现在我们开始创建一个新的 Helm Chart 包。直接使用 <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm create</span><br></pre></td></tr></table></figure><br> 命令即可：<p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">  ➜ helm create my-ghost</span><br><span class="line"></span><br><span class="line">Creating my-ghost</span><br><span class="line">➜ tree my-ghost</span><br><span class="line">my-ghost</span><br><span class="line">├── Chart.yaml</span><br><span class="line">├── charts</span><br><span class="line">├── templates</span><br><span class="line">│   ├── NOTES.txt</span><br><span class="line">│   ├── _helpers.tpl</span><br><span class="line">│   ├── deployment.yaml</span><br><span class="line">│   ├── hpa.yaml</span><br><span class="line">│   ├── ingress.yaml</span><br><span class="line">│   ├── service.yaml</span><br><span class="line">│   ├── serviceaccount.yaml</span><br><span class="line">│   └── tests</span><br><span class="line">│       └── test-connection.yaml</span><br><span class="line">└── values.yaml</span><br><span class="line"></span><br><span class="line"><span class="number">3</span> directories, <span class="number">10</span> files</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>该命令会创建一个默认 Helm Chart 包的脚手架，可以删掉下面的这些使用不到的文件：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  templates/tests/test-connection.yaml</span><br><span class="line">templates/serviceaccount.yaml</span><br><span class="line">templates/ingress.yaml</span><br><span class="line">templates/hpa.yaml</span><br><span class="line">templates/NOTES.txt</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>然后修改 <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">templates/deployment.yaml</span><br></pre></td></tr></table></figure><br> 模板文件：<p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">  # templates/deployment.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: ghost</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: ghost-app</span><br><span class="line">  replicas: &#123;&#123; .Values.replicaCount &#125;&#125;</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: ghost-app</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: ghost-app</span><br><span class="line">          image: &#123;&#123; .Values.image &#125;&#125;</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: <span class="number">2368</span></span><br><span class="line">          env:</span><br><span class="line">            - name: NODE_ENV</span><br><span class="line">              value: &#123;&#123; .Values.node_env | <span class="keyword">default</span> <span class="string">&quot;production&quot;</span> &#125;&#125;</span><br><span class="line">            &#123;&#123;- <span class="keyword">if</span> .Values.url &#125;&#125;</span><br><span class="line">            - name: url</span><br><span class="line">              value: http:<span class="comment">//&#123;&#123; .Values.url &#125;&#125;</span></span><br><span class="line">            &#123;&#123;- end &#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这和我们前面的资源清单文件非常类似，只是将 <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">replicas</span><br></pre></td></tr></table></figure><br> 的值使用 <br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; .Values.replicaCount &#125;&#125;</span><br></pre></td></tr></table></figure><br> 模板来进行替换了，表示会用 <br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">replicaCount</span><br></pre></td></tr></table></figure><br> 这个 Values 值进行渲染，然后还可以通过设置环境变量来配置 Ghost，同样修改 <br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">templates/service.yaml</span><br></pre></td></tr></table></figure><br> 模板文件的内容：<p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">  # templates/service.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: ghost</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: ghost-app</span><br><span class="line">  type: &#123;&#123; .Values.service.type &#125;&#125;</span><br><span class="line">  ports:</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      targetPort: <span class="number">2368</span></span><br><span class="line">      port: &#123;&#123; .Values.service.port &#125;&#125;</span><br><span class="line">      &#123;&#123;- <span class="keyword">if</span> (and (or (eq .Values.service.type <span class="string">&quot;NodePort&quot;</span>) (eq .Values.service.type <span class="string">&quot;LoadBalancer&quot;</span>)) (not (empty .Values.service.nodePort))) &#125;&#125;</span><br><span class="line">      nodePort: &#123;&#123; .Values.service.nodePort &#125;&#125;</span><br><span class="line">      &#123;&#123;- <span class="keyword">else</span> <span class="keyword">if</span> eq .Values.service.type <span class="string">&quot;ClusterIP&quot;</span> &#125;&#125;</span><br><span class="line">      nodePort: <span class="literal">null</span></span><br><span class="line">      &#123;&#123;- end &#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>同样为了能够兼容多个场景，这里我们允许用户来定制 Service 的 type，如果是 NodePort 类型则还可以配置 nodePort 的值，不过需要注意这里的判断，因为有可能即使配置为 NodePort 类型，用户也可能不会主动提供 nodePort，所以这里我们在模板中做了一个条件判断：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;- <span class="keyword">if</span> (and (or (eq .Values.service.type <span class="string">&quot;NodePort&quot;</span>) (eq .Values.service.type <span class="string">&quot;LoadBalancer&quot;</span>)) (not (empty .Values.service.nodePort))) &#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>需要 <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service.type</span><br></pre></td></tr></table></figure><br> 为 NodePort 或者 LoadBalancer 并且 <br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service.nodePort</span><br></pre></td></tr></table></figure><br> 不为空的情况下才会渲染 nodePort。<br>然后最重要的就是要在 <br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">values.yaml</span><br></pre></td></tr></table></figure><br> 文件中提供默认的 Values 值，如下所示是我们提供的默认的 Values 值：<p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">  # values.yaml</span><br><span class="line">replicaCount: <span class="number">1</span></span><br><span class="line">image: ghost</span><br><span class="line">node_env: production</span><br><span class="line">url: ghost.k8s.local</span><br><span class="line"></span><br><span class="line">service:</span><br><span class="line">  type: NodePort</span><br><span class="line">  port: <span class="number">80</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>然后我们可以使用 <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm template</span><br></pre></td></tr></table></figure><br> 命令来渲染我们的模板输出结果：<p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">  ➜ helm template --debug my-ghost</span><br><span class="line">install.go:<span class="number">178</span>: [debug] Original chart version: <span class="string">&quot;&quot;</span></span><br><span class="line">install.go:<span class="number">195</span>: [debug] CHART PATH: /Users/ych/devs/workspace/yidianzhishi/course/k8strain3/content/helm/manifests/my-ghost</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"># Source: my-ghost/templates/service.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: ghost</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: ghost-app</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      targetPort: <span class="number">2368</span></span><br><span class="line">      port: <span class="number">80</span></span><br><span class="line">---</span><br><span class="line"># Source: my-ghost/templates/deployment.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: ghost</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: ghost-app</span><br><span class="line">  replicas: <span class="number">1</span></span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: ghost-app</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: ghost-app</span><br><span class="line">          image: ghost</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: <span class="number">2368</span></span><br><span class="line">          env:</span><br><span class="line">            - name: NODE_ENV</span><br><span class="line">              value: production</span><br><span class="line">            - name: url</span><br><span class="line">              value: http:<span class="comment">//ghost.k8s.local</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上面的渲染结果和我们上面的资源清单文件基本上一致了，只是我们现在的灵活性更大了，比如可以控制环境变量、服务的暴露方式等等。</p><h4 id="命名模板"><a href="#命名模板" class="headerlink" title="命名模板"></a>命名模板</h4><p>虽然现在我们可以使用 Helm Charts 模板来渲染安装 Ghost 了，但是上面我们的模板还有很多改进的地方，比如资源对象的名称我们是固定的，这样我们就没办法在同一个命名空间下面安装多个应用了，所以一般我们也会根据 Chart 名称或者 Release 名称来替换资源对象的名称。<br>前面默认创建的模板中包含一个 <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_helpers.tpl</span><br></pre></td></tr></table></figure><br> 的文件，该文件中包含一些和名称、标签相关的命名模板，我们可以直接使用即可，下面是默认生成的已有的命名模板：<p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">  &#123;&#123;<span class="comment">/*</span></span><br><span class="line"><span class="comment">Expand the name of the chart.</span></span><br><span class="line"><span class="comment">*/</span>&#125;&#125;</span><br><span class="line">&#123;&#123;- define <span class="string">&quot;my-ghost.name&quot;</span> -&#125;&#125;</span><br><span class="line">&#123;&#123;- <span class="keyword">default</span> .Chart.Name .Values.nameOverride | trunc <span class="number">63</span> | trimSuffix <span class="string">&quot;-&quot;</span> &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;<span class="comment">/*</span></span><br><span class="line"><span class="comment">Create a default fully qualified app name.</span></span><br><span class="line"><span class="comment">We truncate at 63 chars because some Kubernetes name fields are limited to this (by the DNS naming spec).</span></span><br><span class="line"><span class="comment">If release name contains chart name it will be used as a full name.</span></span><br><span class="line"><span class="comment">*/</span>&#125;&#125;</span><br><span class="line">&#123;&#123;- define <span class="string">&quot;my-ghost.fullname&quot;</span> -&#125;&#125;</span><br><span class="line">&#123;&#123;- <span class="keyword">if</span> .Values.fullnameOverride &#125;&#125;</span><br><span class="line">&#123;&#123;- .Values.fullnameOverride | trunc <span class="number">63</span> | trimSuffix <span class="string">&quot;-&quot;</span> &#125;&#125;</span><br><span class="line">&#123;&#123;- <span class="keyword">else</span> &#125;&#125;</span><br><span class="line">&#123;&#123;- $name := <span class="keyword">default</span> .Chart.Name .Values.nameOverride &#125;&#125;</span><br><span class="line">&#123;&#123;- <span class="keyword">if</span> contains $name .Release.Name &#125;&#125;</span><br><span class="line">&#123;&#123;- .Release.Name | trunc <span class="number">63</span> | trimSuffix <span class="string">&quot;-&quot;</span> &#125;&#125;</span><br><span class="line">&#123;&#123;- <span class="keyword">else</span> &#125;&#125;</span><br><span class="line">&#123;&#123;- printf <span class="string">&quot;%s-%s&quot;</span> .Release.Name $name | trunc <span class="number">63</span> | trimSuffix <span class="string">&quot;-&quot;</span> &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;<span class="comment">/*</span></span><br><span class="line"><span class="comment">Create chart name and version as used by the chart label.</span></span><br><span class="line"><span class="comment">*/</span>&#125;&#125;</span><br><span class="line">&#123;&#123;- define <span class="string">&quot;my-ghost.chart&quot;</span> -&#125;&#125;</span><br><span class="line">&#123;&#123;- printf <span class="string">&quot;%s-%s&quot;</span> .Chart.Name .Chart.Version | replace <span class="string">&quot;+&quot;</span> <span class="string">&quot;_&quot;</span> | trunc <span class="number">63</span> | trimSuffix <span class="string">&quot;-&quot;</span> &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;<span class="comment">/*</span></span><br><span class="line"><span class="comment">Common labels</span></span><br><span class="line"><span class="comment">*/</span>&#125;&#125;</span><br><span class="line">&#123;&#123;- define <span class="string">&quot;my-ghost.labels&quot;</span> -&#125;&#125;</span><br><span class="line">helm.sh/chart: &#123;&#123; include <span class="string">&quot;my-ghost.chart&quot;</span> . &#125;&#125;</span><br><span class="line">&#123;&#123; include <span class="string">&quot;my-ghost.selectorLabels&quot;</span> . &#125;&#125;</span><br><span class="line">&#123;&#123;- <span class="keyword">if</span> .Chart.AppVersion &#125;&#125;</span><br><span class="line">app.kubernetes.io/version: &#123;&#123; .Chart.AppVersion | quote &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br><span class="line">app.kubernetes.io/managed-by: &#123;&#123; .Release.Service &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;<span class="comment">/*</span></span><br><span class="line"><span class="comment">Selector labels</span></span><br><span class="line"><span class="comment">*/</span>&#125;&#125;</span><br><span class="line">&#123;&#123;- define <span class="string">&quot;my-ghost.selectorLabels&quot;</span> -&#125;&#125;</span><br><span class="line">app.kubernetes.io/name: &#123;&#123; include <span class="string">&quot;my-ghost.name&quot;</span> . &#125;&#125;</span><br><span class="line">app.kubernetes.io/instance: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>然后我们可以将 Deployment 的名称和标签替换掉：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">  # templates/deployment.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: &#123;&#123; template <span class="string">&quot;my-ghost.fullname&quot;</span> . &#125;&#125;</span><br><span class="line">  labels:</span><br><span class="line">&#123;&#123; include <span class="string">&quot;my-ghost.labels&quot;</span> . | indent <span class="number">4</span> &#125;&#125;</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">&#123;&#123; include <span class="string">&quot;my-ghost.selectorLabels&quot;</span> . | indent <span class="number">6</span> &#125;&#125;</span><br><span class="line">  replicas: &#123;&#123; .Values.replicaCount &#125;&#125;</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">&#123;&#123; include <span class="string">&quot;my-ghost.selectorLabels&quot;</span> . | indent <span class="number">8</span> &#125;&#125;</span><br><span class="line">    spec:</span><br><span class="line">    # other spec...</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>为 Deployment 增加 label 标签，同样 labelSelector 中也使用 <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">my-ghost.selectorLabels</span><br></pre></td></tr></table></figure><br> 这个命名模板进行替换，同样对 Service 也做相应的改造：<p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">  apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: &#123;&#123; template <span class="string">&quot;my-ghost.fullname&quot;</span> . &#125;&#125;</span><br><span class="line">  labels:</span><br><span class="line">&#123;&#123; include <span class="string">&quot;my-ghost.labels&quot;</span> . | indent <span class="number">4</span> &#125;&#125;</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">&#123;&#123; include <span class="string">&quot;my-ghost.selectorLabels&quot;</span> . | indent <span class="number">4</span> &#125;&#125;</span><br><span class="line">  type: &#123;&#123; .Values.service.type &#125;&#125;</span><br><span class="line">  # other spec...</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>现在我们可以再使用 <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm template</span><br></pre></td></tr></table></figure><br> 渲染验证结果是否正确：<p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">  ➜ helm template --debug my-ghost</span><br><span class="line">install.go:<span class="number">178</span>: [debug] Original chart version: <span class="string">&quot;&quot;</span></span><br><span class="line">install.go:<span class="number">195</span>: [debug] CHART PATH: /Users/ych/devs/workspace/yidianzhishi/course/k8strain3/content/helm/manifests/my-ghost</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"># Source: my-ghost/templates/service.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: release-name-my-ghost</span><br><span class="line">  labels:</span><br><span class="line">    helm.sh/chart: my-ghost-<span class="number">0.1</span><span class="number">.0</span></span><br><span class="line">    app.kubernetes.io/name: my-ghost</span><br><span class="line">    app.kubernetes.io/instance: release-name</span><br><span class="line">    app.kubernetes.io/version: <span class="string">&quot;1.16.0&quot;</span></span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app.kubernetes.io/name: my-ghost</span><br><span class="line">    app.kubernetes.io/instance: release-name</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      targetPort: <span class="number">2368</span></span><br><span class="line">      port: <span class="number">80</span></span><br><span class="line">---</span><br><span class="line"># Source: my-ghost/templates/deployment.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: release-name-my-ghost</span><br><span class="line">  labels:</span><br><span class="line">    helm.sh/chart: my-ghost-<span class="number">0.1</span><span class="number">.0</span></span><br><span class="line">    app.kubernetes.io/name: my-ghost</span><br><span class="line">    app.kubernetes.io/instance: release-name</span><br><span class="line">    app.kubernetes.io/version: <span class="string">&quot;1.16.0&quot;</span></span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app.kubernetes.io/name: my-ghost</span><br><span class="line">      app.kubernetes.io/instance: release-name</span><br><span class="line">  replicas: <span class="number">1</span></span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app.kubernetes.io/name: my-ghost</span><br><span class="line">        app.kubernetes.io/instance: release-name</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: ghost-app</span><br><span class="line">          image: ghost</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: <span class="number">2368</span></span><br><span class="line">          env:</span><br><span class="line">            - name: NODE_ENV</span><br><span class="line">              value: production</span><br><span class="line">            - name: url</span><br><span class="line">              value: http:<span class="comment">//ghost.k8s.local</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="版本兼容"><a href="#版本兼容" class="headerlink" title="版本兼容"></a>版本兼容</h4><p>由于 Kubernetes 的版本迭代非常快，所以我们在开发 Chart 包的时候有必要考虑到对不同版本的 Kubernetes 进行兼容，最明显的就是 Ingress 的资源版本。Kubernetes 在 1.19 版本为 Ingress 资源引入了一个新的 API：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">networking.k8s.io/v1</span><br></pre></td></tr></table></figure><br>，这与之前的 <br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">networking.k8s.io/v1beta1</span><br></pre></td></tr></table></figure><br> beta 版本使用方式基本一致，但是和前面的 <br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extensions/v1beta1</span><br></pre></td></tr></table></figure><br> 这个版本在使用上有很大的不同，资源对象的属性上有一定的区别，所以要兼容不同的版本，我们就需要对模板中的 Ingress 对象做兼容处理。<br>新版本的资源对象格式如下所示：<p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">  apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: minimal-ingress</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/rewrite-target: /</span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: nginx</span><br><span class="line">  rules:</span><br><span class="line">  - http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /testpath</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: test</span><br><span class="line">            port:</span><br><span class="line">              number: <span class="number">80</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>而旧版本的资源对象格式如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">  apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: minimal-ingress</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: nginx</span><br><span class="line">    nginx.ingress.kubernetes.io/rewrite-target: /</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /testpath</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: test</span><br><span class="line">          servicePort: <span class="number">80</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>现在我们再为 Ghost 添加一个 Ingress 的模板，新建 <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">templates/ingress.yaml</span><br></pre></td></tr></table></figure><br> 模板文件，先添加一个 v1 版本的 Ingress 模板：<p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">  apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ghost</span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: nginx</span><br><span class="line">  rules:</span><br><span class="line">  - host: ghost.k8s.local</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: ghost</span><br><span class="line">            port:</span><br><span class="line">              number: <span class="number">80</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>然后同样将名称和服务名称这些使用模板参数进行替换：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">  apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: &#123;&#123; template <span class="string">&quot;my-ghost.fullname&quot;</span> . &#125;&#125;</span><br><span class="line">  labels:</span><br><span class="line">&#123;&#123; include <span class="string">&quot;my-ghost.labels&quot;</span> . | indent <span class="number">4</span> &#125;&#125;</span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: nginx</span><br><span class="line">  rules:</span><br><span class="line">  - host: &#123;&#123; .Values.url &#125;&#125;</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: &#123;&#123; template <span class="string">&quot;my-ghost.fullname&quot;</span> . &#125;&#125;</span><br><span class="line">            port:</span><br><span class="line">              number: &#123;&#123; .Values.service.port &#125;&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>然后接下来我们来兼容下其他的版本格式，这里需要用到 <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Capabilities</span><br></pre></td></tr></table></figure><br> 对象，在 Chart 包的 <br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_helpers.tpl</span><br></pre></td></tr></table></figure><br> 文件中添加几个用于判断集群版本或 API 的命名模板：<p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">  &#123;&#123;<span class="comment">/* Allow KubeVersion to be overridden. */</span>&#125;&#125;</span><br><span class="line">&#123;&#123;- define <span class="string">&quot;my-ghost.kubeVersion&quot;</span> -&#125;&#125;</span><br><span class="line">  &#123;&#123;- <span class="keyword">default</span> .Capabilities.KubeVersion.Version .Values.kubeVersionOverride -&#125;&#125;</span><br><span class="line">&#123;&#123;- end -</span><br><span class="line"></span><br><span class="line">&#123;&#123;<span class="comment">/* Get Ingress API Version */</span>&#125;&#125;</span><br><span class="line">&#123;&#123;- define <span class="string">&quot;my-ghost.ingress.apiVersion&quot;</span> -&#125;&#125;</span><br><span class="line">  &#123;&#123;- <span class="keyword">if</span> <span class="title function_">and</span> <span class="params">(.Capabilities.APIVersions.Has <span class="string">&quot;networking.k8s.io/v1&quot;</span>)</span> (semverCompare <span class="string">&quot;&gt;= 1.19-0&quot;</span> (include <span class="string">&quot;my-ghost.kubeVersion&quot;</span> .)) -&#125;&#125;</span><br><span class="line">      &#123;&#123;- print <span class="string">&quot;networking.k8s.io/v1&quot;</span> -&#125;&#125;</span><br><span class="line">  &#123;&#123;- <span class="keyword">else</span> <span class="keyword">if</span> .Capabilities.APIVersions.Has <span class="string">&quot;networking.k8s.io/v1beta1&quot;</span> -&#125;&#125;</span><br><span class="line">    &#123;&#123;- print <span class="string">&quot;networking.k8s.io/v1beta1&quot;</span> -&#125;&#125;</span><br><span class="line">  &#123;&#123;- <span class="keyword">else</span> -&#125;&#125;</span><br><span class="line">    &#123;&#123;- print <span class="string">&quot;extensions/v1beta1&quot;</span> -&#125;&#125;</span><br><span class="line">  &#123;&#123;- end -&#125;&#125;</span><br><span class="line">&#123;&#123;- end -&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;<span class="comment">/* Check Ingress stability */</span>&#125;&#125;</span><br><span class="line">&#123;&#123;- define <span class="string">&quot;my-ghost.ingress.isStable&quot;</span> -&#125;&#125;</span><br><span class="line">  &#123;&#123;- eq (include <span class="string">&quot;my-ghost.ingress.apiVersion&quot;</span> .) <span class="string">&quot;networking.k8s.io/v1&quot;</span> -&#125;&#125;</span><br><span class="line">&#123;&#123;- end -&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;<span class="comment">/* Check Ingress supports pathType */</span>&#125;&#125;</span><br><span class="line">&#123;&#123;<span class="comment">/* pathType was added to networking.k8s.io/v1beta1 in Kubernetes 1.18 */</span>&#125;&#125;</span><br><span class="line">&#123;&#123;- define <span class="string">&quot;my-ghost.ingress.supportsPathType&quot;</span> -&#125;&#125;</span><br><span class="line">  &#123;&#123;- or (eq (include <span class="string">&quot;my-ghost.ingress.isStable&quot;</span> .) <span class="string">&quot;true&quot;</span>) (and (eq (include <span class="string">&quot;my-ghost.ingress.apiVersion&quot;</span> .) <span class="string">&quot;networking.k8s.io/v1beta1&quot;</span>) (semverCompare <span class="string">&quot;&gt;= 1.18-0&quot;</span> (include <span class="string">&quot;my-ghost.kubeVersion&quot;</span> .))) -&#125;&#125;</span><br><span class="line">&#123;&#123;- end -&#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上面我们通过 <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.Capabilities.APIVersions.Has</span><br></pre></td></tr></table></figure><br> 来判断我们应该使用的 APIVersion，如果版本为 <br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">networking.k8s.io/v1</span><br></pre></td></tr></table></figure><br>，则定义为 <br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">isStable</span><br></pre></td></tr></table></figure><br>，此外还根据版本来判断是否需要支持 <br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pathType</span><br></pre></td></tr></table></figure><br> 属性，然后在 Ingress 对象模板中就可以使用上面定义的命名模板来决定应该使用哪些属性，如下所示：<p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">  &#123;&#123;- <span class="keyword">if</span> .Values.ingress.enabled &#125;&#125;</span><br><span class="line">&#123;&#123;- $apiIsStable := eq (include <span class="string">&quot;my-ghost.ingress.isStable&quot;</span> .) <span class="string">&quot;true&quot;</span> -&#125;&#125;</span><br><span class="line">&#123;&#123;- $ingressSupportsPathType := eq (include <span class="string">&quot;my-ghost.ingress.supportsPathType&quot;</span> .) <span class="string">&quot;true&quot;</span> -&#125;&#125;</span><br><span class="line">apiVersion: &#123;&#123; include <span class="string">&quot;my-ghost.ingress.apiVersion&quot;</span> . &#125;&#125;</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: &#123;&#123; template <span class="string">&quot;my-ghost.fullname&quot;</span> . &#125;&#125;</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/ssl-redirect: <span class="string">&quot;false&quot;</span></span><br><span class="line">    &#123;&#123;- <span class="keyword">if</span> and .Values.ingress.ingressClass (not $apiIsStable) &#125;&#125;</span><br><span class="line">    kubernetes.io/ingress.class: &#123;&#123; .Values.ingress.ingressClass &#125;&#125;</span><br><span class="line">    &#123;&#123;- end &#125;&#125;</span><br><span class="line">  labels:</span><br><span class="line">    &#123;&#123;- include <span class="string">&quot;my-ghost.labels&quot;</span> . | nindent <span class="number">4</span> &#125;&#125;</span><br><span class="line">spec:</span><br><span class="line">  &#123;&#123;- <span class="keyword">if</span> and .Values.ingress.ingressClass $apiIsStable &#125;&#125;</span><br><span class="line">  ingressClassName: &#123;&#123; .Values.ingress.ingressClass &#125;&#125;</span><br><span class="line">  &#123;&#123;- end &#125;&#125;</span><br><span class="line">  rules:</span><br><span class="line">  &#123;&#123;- <span class="keyword">if</span> <span class="title function_">not</span> <span class="params">(empty .Values.url)</span> &#125;&#125;</span><br><span class="line">  - host: &#123;&#123; .Values.url &#125;&#125;</span><br><span class="line">    http:</span><br><span class="line">  &#123;&#123;- <span class="keyword">else</span> &#125;&#125;</span><br><span class="line">  - http:</span><br><span class="line">  &#123;&#123;- end &#125;&#125;</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        &#123;&#123;- <span class="keyword">if</span> $ingressSupportsPathType &#125;&#125;</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        &#123;&#123;- end &#125;&#125;</span><br><span class="line">        backend:</span><br><span class="line">          &#123;&#123;- <span class="keyword">if</span> $apiIsStable &#125;&#125;</span><br><span class="line">          service:</span><br><span class="line">            name: &#123;&#123; template <span class="string">&quot;my-ghost.fullname&quot;</span> . &#125;&#125;</span><br><span class="line">            port:</span><br><span class="line">              number: &#123;&#123; .Values.service.port &#125;&#125;</span><br><span class="line">          &#123;&#123;- <span class="keyword">else</span> &#125;&#125;</span><br><span class="line">          serviceName: &#123;&#123; template <span class="string">&quot;my-ghost.fullname&quot;</span> . &#125;&#125;</span><br><span class="line">          servicePort: &#123;&#123; .Values.service.port &#125;&#125;</span><br><span class="line">          &#123;&#123;- end &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>由于有的场景下面并不需要使用 Ingress 来暴露服务，所以首先我们通过一个 <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ingress.enabled</span><br></pre></td></tr></table></figure><br> 属性来控制是否需要渲染，然后定义了一个 <br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$apiIsStable</span><br></pre></td></tr></table></figure><br> 变量，来表示当前集群是否是稳定版本的 API，然后需要根据该变量去渲染不同的属性，比如对于 ingressClass，如果是稳定版本的 API 则是通过 <br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spec.ingressClassName</span><br></pre></td></tr></table></figure><br> 来指定，否则是通过 <br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubernetes.io/ingress.class</span><br></pre></td></tr></table></figure><br> 这个 annotations 来指定。然后这里我们在 <br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">values.yaml</span><br></pre></td></tr></table></figure><br> 文件中添加如下所示默认的 Ingress 的配置数据：<p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ingress:</span><br><span class="line">  enabled: <span class="literal">true</span></span><br><span class="line">  ingressClass: nginx</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>现在我们再次渲染 Helm Chart 模板来验证资源清单数据：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">  ➜ helm template --debug my-ghost</span><br><span class="line">install.go:<span class="number">178</span>: [debug] Original chart version: <span class="string">&quot;&quot;</span></span><br><span class="line">install.go:<span class="number">195</span>: [debug] CHART PATH: /Users/ych/devs/workspace/yidianzhishi/course/k8strain3/content/helm/manifests/my-ghost</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"># Source: my-ghost/templates/service.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: release-name-my-ghost</span><br><span class="line">  labels:</span><br><span class="line">    helm.sh/chart: my-ghost-<span class="number">0.1</span><span class="number">.0</span></span><br><span class="line">    app.kubernetes.io/name: my-ghost</span><br><span class="line">    app.kubernetes.io/instance: release-name</span><br><span class="line">    app.kubernetes.io/version: <span class="string">&quot;1.16.0&quot;</span></span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app.kubernetes.io/name: my-ghost</span><br><span class="line">    app.kubernetes.io/instance: release-name</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      targetPort: <span class="number">2368</span></span><br><span class="line">      port: <span class="number">80</span></span><br><span class="line">---</span><br><span class="line"># Source: my-ghost/templates/deployment.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: release-name-my-ghost</span><br><span class="line">  labels:</span><br><span class="line">    helm.sh/chart: my-ghost-<span class="number">0.1</span><span class="number">.0</span></span><br><span class="line">    app.kubernetes.io/name: my-ghost</span><br><span class="line">    app.kubernetes.io/instance: release-name</span><br><span class="line">    app.kubernetes.io/version: <span class="string">&quot;1.16.0&quot;</span></span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app.kubernetes.io/name: my-ghost</span><br><span class="line">      app.kubernetes.io/instance: release-name</span><br><span class="line">  replicas: <span class="number">1</span></span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app.kubernetes.io/name: my-ghost</span><br><span class="line">        app.kubernetes.io/instance: release-name</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: ghost-app</span><br><span class="line">          image: ghost</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: <span class="number">2368</span></span><br><span class="line">          env:</span><br><span class="line">            - name: NODE_ENV</span><br><span class="line">              value: production</span><br><span class="line">            - name: url</span><br><span class="line">              value: http:<span class="comment">//ghost.k8s.local</span></span><br><span class="line">---</span><br><span class="line"># Source: my-ghost/templates/ingress.yaml</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: release-name-my-ghost</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/ssl-redirect: <span class="string">&quot;false&quot;</span></span><br><span class="line">  labels:</span><br><span class="line">    helm.sh/chart: my-ghost-<span class="number">0.1</span><span class="number">.0</span></span><br><span class="line">    app.kubernetes.io/name: my-ghost</span><br><span class="line">    app.kubernetes.io/instance: release-name</span><br><span class="line">    app.kubernetes.io/version: <span class="string">&quot;1.16.0&quot;</span></span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: nginx</span><br><span class="line">  rules:</span><br><span class="line">  - host: ghost.k8s.local</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: release-name-my-ghost</span><br><span class="line">            port:</span><br><span class="line">              number: <span class="number">80</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>从上面的资源清单可以看出是符合我们的预期要求的，我们可以来安装测试下结果：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">  ➜ helm upgrade --install my-ghost ./my-ghost -n <span class="keyword">default</span></span><br><span class="line">Release <span class="string">&quot;my-ghost&quot;</span> does not exist. Installing it now.</span><br><span class="line">NAME: my-ghost</span><br><span class="line">LAST DEPLOYED: Thu Mar <span class="number">17</span> <span class="number">13</span>:<span class="number">11</span>:<span class="number">15</span> <span class="number">2022</span></span><br><span class="line">NAMESPACE: <span class="keyword">default</span></span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: <span class="number">1</span></span><br><span class="line">TEST SUITE: None</span><br><span class="line"></span><br><span class="line">➜ helm ls -n <span class="keyword">default</span></span><br><span class="line">NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                APP VERSION</span><br><span class="line">my-ghost        <span class="keyword">default</span>         <span class="number">1</span>               <span class="number">2022</span>-<span class="number">03</span>-<span class="number">17</span> <span class="number">13</span>:<span class="number">11</span>:<span class="number">15.79828</span> +0800 CST     deployed        my-ghost-<span class="number">0.1</span><span class="number">.0</span>       <span class="number">1.16</span><span class="number">.0</span></span><br><span class="line">➜ kubectl get pods -n <span class="keyword">default</span></span><br><span class="line">NAME                        READY   STATUS      RESTARTS   AGE</span><br><span class="line">my-ghost-7cf7fb6484-75hkk   <span class="number">1</span>/<span class="number">1</span>     Running     <span class="number">0</span>          3m9s</span><br><span class="line">➜ kubectl get svc -n <span class="keyword">default</span></span><br><span class="line">NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   <span class="title function_">PORT</span><span class="params">(S)</span>        AGE</span><br><span class="line">kubernetes   ClusterIP   <span class="number">10.96</span><span class="number">.0</span><span class="number">.1</span>        &lt;none&gt;        <span class="number">443</span>/TCP        <span class="number">142d</span></span><br><span class="line">my-ghost     NodePort    <span class="number">10.108</span><span class="number">.125</span><span class="number">.187</span>   &lt;none&gt;        <span class="number">80</span>:<span class="number">32433</span>/TCP   3m20s</span><br><span class="line">➜ kubectl get ingress -n <span class="keyword">default</span></span><br><span class="line">NAME       CLASS   HOSTS             ADDRESS         PORTS   AGE</span><br><span class="line">my-ghost   nginx   ghost.k8s.local   <span class="number">192.168</span><span class="number">.31</span><span class="number">.31</span>   <span class="number">80</span>      3m32s</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>正常就可以部署成功 Ghost 了，并且可以通过域名 <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//ghost.k8s.local</span></span><br></pre></td></tr></table></figure><br> 进行访问了：<p></p><p>Ghost</p><h4 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h4><p>上面我们使用的 Ghost 镜像默认使用 SQLite 数据库，所以非常有必要将数据进行持久化，当然我们要将这个开关给到用户去选择，修改 <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">templates/deployment.yaml</span><br></pre></td></tr></table></figure><br> 模板文件，增加 volumes 相关配置：<p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">  # other spec...</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">    - name: ghost-data</span><br><span class="line">    &#123;&#123;- <span class="keyword">if</span> .Values.persistence.enabled &#125;&#125;</span><br><span class="line">      persistentVolumeClaim:</span><br><span class="line">        claimName: &#123;&#123; .Values.persistence.existingClaim | <span class="keyword">default</span> (include <span class="string">&quot;my-ghost.fullname&quot;</span> .) &#125;&#125;</span><br><span class="line">    &#123;&#123;- <span class="keyword">else</span> &#125;&#125;</span><br><span class="line">      emptyDir: &#123;&#125;</span><br><span class="line">    &#123;&#123; end &#125;&#125;</span><br><span class="line">  containers:</span><br><span class="line">    - name: ghost-app</span><br><span class="line">      image: &#123;&#123; .Values.image &#125;&#125;</span><br><span class="line">      volumeMounts:</span><br><span class="line">        - name: ghost-data</span><br><span class="line">          mountPath: /<span class="keyword">var</span>/lib/ghost/content</span><br><span class="line">      # other spec...</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这里我们通过 <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">persistence.enabled</span><br></pre></td></tr></table></figure><br> 来判断是否需要开启持久化数据，如果开启则需要看用户是否直接提供了一个存在的 PVC 对象，如果没有提供，则我们需要自己创建一个合适的 PVC 对象，如果不需要持久化，则直接使用 <br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">emptyDir:&#123;&#125;</span><br></pre></td></tr></table></figure><br> 即可，添加 <br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">templates/pvc.yaml</span><br></pre></td></tr></table></figure><br> 模板，内容如下所示：<p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">  &#123;&#123;- <span class="keyword">if</span> and .Values.persistence.enabled (not .Values.persistence.existingClaim) &#125;&#125;</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: &#123;&#123; template <span class="string">&quot;my-ghost.fullname&quot;</span> . &#125;&#125;</span><br><span class="line">  labels:</span><br><span class="line">    &#123;&#123;- include <span class="string">&quot;my-ghost.labels&quot;</span> . | nindent <span class="number">4</span> &#125;&#125;</span><br><span class="line">spec:</span><br><span class="line">  &#123;&#123;- <span class="keyword">if</span> .Values.persistence.storageClass &#125;&#125;</span><br><span class="line">  storageClassName: &#123;&#123; .Values.persistence.storageClass | quote &#125;&#125;</span><br><span class="line">  &#123;&#123;- end &#125;&#125;</span><br><span class="line">  accessModes:</span><br><span class="line">  - &#123;&#123; .Values.persistence.accessMode | quote &#125;&#125;</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: &#123;&#123; .Values.persistence.size | quote &#125;&#125;</span><br><span class="line">&#123;&#123;- end -&#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>其中访问模式、存储容量、StorageClass、存在的 PVC 都通过 Values 来指定，增加了灵活性。对应的 <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">values.yaml</span><br></pre></td></tr></table></figure><br> 配置部分我们可以给一个默认的配置：<p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  ## 是否使用 PVC 开启数据持久化</span><br><span class="line">persistence:</span><br><span class="line">  enabled: <span class="literal">true</span></span><br><span class="line">  ## 是否使用 storageClass，如果不适用则补配置</span><br><span class="line">  # storageClass: <span class="string">&quot;xxx&quot;</span></span><br><span class="line">  ##</span><br><span class="line">  ## 如果想使用一个存在的 PVC 对象，则直接传递给下面的 existingClaim 变量</span><br><span class="line">  # existingClaim: your-claim</span><br><span class="line">  accessMode: ReadWriteOnce  # 访问模式</span><br><span class="line">  size: 1Gi  # 存储容量</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="定制"><a href="#定制" class="headerlink" title="定制"></a>定制</h4><p>除了上面的这些主要的需求之外，还有一些额外的定制需求，比如用户想要配置更新策略，因为更新策略并不是一层不变的，这里和之前不太一样，我们需要用到一个新的函数 <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">toYaml</span><br></pre></td></tr></table></figure><br>：<p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  &#123;&#123;- <span class="keyword">if</span> .Values.updateStrategy &#125;&#125;</span><br><span class="line">strategy: &#123;&#123; toYaml .Values.updateStrategy | nindent <span class="number">4</span> &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>意思就是我们将 <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">updateStrategy</span><br></pre></td></tr></table></figure><br> 这个 Values 值转换成 YAML 格式，并保留4个空格。然后添加其他的配置，比如是否需要添加 nodeSelector、容忍、亲和性这些，这里我们都是使用 <br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">toYaml</span><br></pre></td></tr></table></figure><br> 函数来控制空格，如下所示：<p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">  &#123;&#123;- <span class="keyword">if</span> .Values.nodeSelector &#125;&#125;</span><br><span class="line">nodeSelector: &#123;&#123;- toYaml .Values.nodeSelector | nindent <span class="number">8</span> &#125;&#125;</span><br><span class="line">&#123;&#123;- end -&#125;&#125;</span><br><span class="line">&#123;&#123;- with .Values.affinity &#125;&#125;</span><br><span class="line">affinity: &#123;&#123;- toYaml . | nindent <span class="number">8</span> &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br><span class="line">&#123;&#123;- with .Values.tolerations &#125;&#125;</span><br><span class="line">tolerations: &#123;&#123;- toYaml . | nindent <span class="number">8</span> &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>接下来当然就是镜像的配置了，如果是私有仓库还需要指定 <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">imagePullSecrets</span><br></pre></td></tr></table></figure><br>：<p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">  &#123;&#123;- <span class="keyword">if</span> .Values.image.pullSecrets &#125;&#125;</span><br><span class="line">imagePullSecrets:</span><br><span class="line">&#123;&#123;- range .Values.image.pullSecrets &#125;&#125;</span><br><span class="line">- name: &#123;&#123; . &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br><span class="line">containers:</span><br><span class="line">- name: ghost</span><br><span class="line">  image: &#123;&#123; printf <span class="string">&quot;%s:%s&quot;</span> .Values.image.name .Values.image.tag &#125;&#125;</span><br><span class="line">  imagePullPolicy: &#123;&#123; .Values.image.pullPolicy | quote &#125;&#125;</span><br><span class="line">  ports:</span><br><span class="line">  - containerPort: <span class="number">2368</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>对应的 Values 值如下所示：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">image:</span><br><span class="line">  name: ghost</span><br><span class="line">  tag: latest</span><br><span class="line">  pullPolicy: IfNotPresent</span><br><span class="line">  ## 如果是私有仓库，需要指定 imagePullSecrets</span><br><span class="line">  # pullSecrets:</span><br><span class="line">  #   - myRegistryKeySecretName</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>然后就是 resource 资源声明，这里我们定义一个默认的 resources 值，同样用 <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">toYaml</span><br></pre></td></tr></table></figure><br> 函数来控制空格：<p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  resources:</span><br><span class="line">&#123;&#123; toYaml .Values.resources | indent <span class="number">10</span> &#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>最后是健康检查部分，虽然我们之前没有做 livenessProbe，但是我们开发 Chart 模板的时候就要尽可能考虑周全一点，这里我们加上存活性和可读性、启动三个探针，并且根据 <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">livenessProbe.enabled</span><br></pre></td></tr></table></figure><br> 、<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readinessProbe.enabled</span><br></pre></td></tr></table></figure><br> 以及 <br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">startupProbe.enabled</span><br></pre></td></tr></table></figure><br> 三个 Values 值来判断是否需要添加探针，探针对应的参数也都通过 Values 值来配置：<p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">  &#123;&#123;- <span class="keyword">if</span> .Values.startupProbe.enabled &#125;&#125;</span><br><span class="line">startupProbe:</span><br><span class="line">  httpGet:</span><br><span class="line">    path: /</span><br><span class="line">    port: <span class="number">2368</span></span><br><span class="line">  initialDelaySeconds: &#123;&#123; .Values.startupProbe.initialDelaySeconds &#125;&#125;</span><br><span class="line">  periodSeconds: &#123;&#123; .Values.startupProbe.periodSeconds &#125;&#125;</span><br><span class="line">  timeoutSeconds: &#123;&#123; .Values.startupProbe.timeoutSeconds &#125;&#125;</span><br><span class="line">  failureThreshold: &#123;&#123; .Values.startupProbe.failureThreshold &#125;&#125;</span><br><span class="line">  successThreshold: &#123;&#123; .Values.startupProbe.successThreshold &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br><span class="line">&#123;&#123;- <span class="keyword">if</span> .Values.livenessProbe.enabled &#125;&#125;</span><br><span class="line">livenessProbe:</span><br><span class="line">  httpGet:</span><br><span class="line">    path: /</span><br><span class="line">    port: <span class="number">2368</span></span><br><span class="line">  initialDelaySeconds: &#123;&#123; .Values.livenessProbe.initialDelaySeconds &#125;&#125;</span><br><span class="line">  periodSeconds: &#123;&#123; .Values.livenessProbe.periodSeconds &#125;&#125;</span><br><span class="line">  timeoutSeconds: &#123;&#123; .Values.livenessProbe.timeoutSeconds &#125;&#125;</span><br><span class="line">  failureThreshold: &#123;&#123; .Values.livenessProbe.failureThreshold &#125;&#125;</span><br><span class="line">  successThreshold: &#123;&#123; .Values.livenessProbe.successThreshold &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br><span class="line">&#123;&#123;- <span class="keyword">if</span> .Values.readinessProbe.enabled &#125;&#125;</span><br><span class="line">readinessProbe:</span><br><span class="line">  httpGet:</span><br><span class="line">    path: /</span><br><span class="line">    port: <span class="number">2368</span></span><br><span class="line">  initialDelaySeconds: &#123;&#123; .Values.readinessProbe.initialDelaySeconds &#125;&#125;</span><br><span class="line">  periodSeconds: &#123;&#123; .Values.readinessProbe.periodSeconds &#125;&#125;</span><br><span class="line">  timeoutSeconds: &#123;&#123; .Values.readinessProbe.timeoutSeconds &#125;&#125;</span><br><span class="line">  failureThreshold: &#123;&#123; .Values.readinessProbe.failureThreshold &#125;&#125;</span><br><span class="line">  successThreshold: &#123;&#123; .Values.readinessProbe.successThreshold &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>默认的 <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">values.yaml</span><br></pre></td></tr></table></figure><br> 文件如下所示：<p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">  replicaCount: <span class="number">1</span></span><br><span class="line">image:</span><br><span class="line">  name: ghost</span><br><span class="line">  tag: latest</span><br><span class="line">  pullPolicy: IfNotPresent</span><br><span class="line"></span><br><span class="line">node_env: production</span><br><span class="line">url: ghost.k8s.local</span><br><span class="line"></span><br><span class="line">service:</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  port: <span class="number">80</span></span><br><span class="line"></span><br><span class="line">ingress:</span><br><span class="line">  enabled: <span class="literal">true</span></span><br><span class="line">  ingressClass: nginx</span><br><span class="line"></span><br><span class="line">## 是否使用 PVC 开启数据持久化</span><br><span class="line">persistence:</span><br><span class="line">  enabled: <span class="literal">true</span></span><br><span class="line">  ## 是否使用 storageClass，如果不适用则补配置</span><br><span class="line">  # storageClass: <span class="string">&quot;xxx&quot;</span></span><br><span class="line">  ##</span><br><span class="line">  ## 如果想使用一个存在的 PVC 对象，则直接传递给下面的 existingClaim 变量</span><br><span class="line">  # existingClaim: your-claim</span><br><span class="line">  accessMode: ReadWriteOnce  # 访问模式</span><br><span class="line">  size: 1Gi  # 存储��量</span><br><span class="line"></span><br><span class="line">nodeSelector: &#123;&#125;</span><br><span class="line"></span><br><span class="line">affinity: &#123;&#125;</span><br><span class="line"></span><br><span class="line">tolerations: &#123;&#125;</span><br><span class="line"></span><br><span class="line">resources: &#123;&#125;</span><br><span class="line"></span><br><span class="line">startupProbe:</span><br><span class="line">  enabled: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">livenessProbe:</span><br><span class="line">  enabled: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">readinessProbe:</span><br><span class="line">  enabled: <span class="literal">false</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>现在我们再去更新 Release：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">  ➜ helm upgrade --install my-ghost ./my-ghost -n <span class="keyword">default</span></span><br><span class="line">Release <span class="string">&quot;my-ghost&quot;</span> has been upgraded. Happy Helming!</span><br><span class="line">NAME: my-ghost</span><br><span class="line">LAST DEPLOYED: Thu Mar <span class="number">17</span> <span class="number">16</span>:<span class="number">03</span>:<span class="number">02</span> <span class="number">2022</span></span><br><span class="line">NAMESPACE: <span class="keyword">default</span></span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: <span class="number">2</span></span><br><span class="line">TEST SUITE: None</span><br><span class="line">➜ helm ls -n <span class="keyword">default</span></span><br><span class="line">NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART            APP VERSION</span><br><span class="line">my-ghost        <span class="keyword">default</span>         <span class="number">2</span>               <span class="number">2022</span>-<span class="number">03</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">07.123349</span> +0800 CST    deployed        my-ghost-<span class="number">0.1</span><span class="number">.0</span>   <span class="number">1.16</span><span class="number">.0</span></span><br><span class="line">➜ kubectl get pods -n <span class="keyword">default</span></span><br><span class="line">NAME                        READY   STATUS      RESTARTS   AGE</span><br><span class="line">my-ghost-6dbc455fc7-cmm4p   <span class="number">1</span>/<span class="number">1</span>     Running     <span class="number">0</span>          2m42s</span><br><span class="line">➜ kubectl get pvc -n <span class="keyword">default</span></span><br><span class="line">NAME       STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">my-ghost   Bound    pvc-2f0b7d5a-04d4-<span class="number">4331</span>-848b-af21edce673e   1Gi        RWO            nfs-client     4m59s</span><br><span class="line">➜ kubectl get ingress -n <span class="keyword">default</span></span><br><span class="line">NAME       CLASS   HOSTS             ADDRESS         PORTS   AGE</span><br><span class="line">my-ghost   nginx   ghost.k8s.local   <span class="number">192.168</span><span class="number">.31</span><span class="number">.31</span>   <span class="number">80</span>      3h24m</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>到这里我们就基本完成了这个简单的 Helm Charts 包的开发，当然以后可能还会有新的需求，我们需要不断去迭代优化。</p><h4 id="共享-Charts"><a href="#共享-Charts" class="headerlink" title="共享 Charts"></a>共享 Charts</h4><p>Helm Charts 包开发完成了，如果别人想要使用我们的包，则需要我们共享出去，我们可以通过 Chart 仓库来进行共享，Helm Charts 可以在远程存储库或本地环境&#x2F;存储库中使用，远程存储库可以是公共的，如 Bitnami Charts 也可以是托管存储库，如 Google Cloud Storage 或 GitHub。为了演示方便，这里我们使用 GitHub 来托管我们的 Charts 包。<br>我们可以使用 GitHub Pages 来创建 Charts 仓库，GitHub 允许我们以两种不同的方式提供静态网页：</p><p>通过配置项目提供其 <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docs/</span><br></pre></td></tr></table></figure><br> 目录的内容<br>通过配置项目来服务特定的分支<p></p><p>这里我们将采用第二种方法，首先在 GitHub 上创建一个代码仓库：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/cnych/helm101%EF%BC%8C%E5%B0%86%E4%B8%8A%E9%9D%A2%E6%88%91%E4%BB%AC%E5%88%9B%E5%BB%BA%E7%9A%84">https://github.com/cnych/helm101，将上面我们创建的</a> <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">my-ghost</span><br></pre></td></tr></table></figure><br> 包提交到仓库 <br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">charts</span><br></pre></td></tr></table></figure><br> 目录下，然后打包 chart 包：<p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  ➜ helm <span class="keyword">package</span> charts/my-ghost</span><br><span class="line">Successfully packaged chart and saved it to: /Users/ych/devs/workspace/yidianzhishi/course/k8strain3/content/helm/manifests/helm101/my-ghost-<span class="number">0.1</span><span class="number">.0</span>.tgz</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我们可以将打包的压缩包放到另外的目录 <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">repo/stable</span><br></pre></td></tr></table></figure><br> 中去，现在仓库的结构如下所示：<p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">  ➜ tree .</span><br><span class="line">.</span><br><span class="line">├── LICENSE</span><br><span class="line">├── README.md</span><br><span class="line">├── charts</span><br><span class="line">│   └── my-ghost</span><br><span class="line">│       ├── Chart.lock</span><br><span class="line">│       ├── Chart.yaml</span><br><span class="line">│       ├── charts</span><br><span class="line">│       ├── templates</span><br><span class="line">│       │   ├── _helpers.tpl</span><br><span class="line">│       │   ├── deployment.yaml</span><br><span class="line">│       │   ├── ingress.yaml</span><br><span class="line">│       │   ├── pvc.yaml</span><br><span class="line">│       │   ├── service.yaml</span><br><span class="line">│       │   └── tests</span><br><span class="line">│       └── values.yaml</span><br><span class="line">└── repo</span><br><span class="line">    └── stable</span><br><span class="line">        └── my-ghost-<span class="number">0.1</span><span class="number">.0</span>.tgz</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>执行如下所示命令生成 index 索引文件：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜ helm repo index repo/stable --url https:<span class="comment">//raw.githubusercontent.com/cnych/helm101/main/repo/stable</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上述命令会在 <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">repo/stable</span><br></pre></td></tr></table></figure><br> 目录下面生成一个如下所示的 <br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index.yaml</span><br></pre></td></tr></table></figure><br> 文件：<p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">  apiVersion: v1</span><br><span class="line">entries:</span><br><span class="line">  my-ghost:</span><br><span class="line">  - apiVersion: v2</span><br><span class="line">    appVersion: <span class="number">1.16</span><span class="number">.0</span></span><br><span class="line">    created: <span class="string">&quot;2022-03-17T17:40:21.093654+08:00&quot;</span></span><br><span class="line">    description: A Helm chart <span class="keyword">for</span> Kubernetes</span><br><span class="line">    digest: f6d6308d6a6cd6357ab2b952650250c2df7b2727ce84c19150531fd72732626b</span><br><span class="line">    name: my-ghost</span><br><span class="line">    type: application</span><br><span class="line">    urls:</span><br><span class="line">    - https:<span class="comment">//raw.githubusercontent.com/cnych/helm101/main/repo/stable/my-ghost-0.1.0.tgz</span></span><br><span class="line">    version: <span class="number">0.1</span><span class="number">.0</span></span><br><span class="line">generated: <span class="string">&quot;2022-03-17T17:40:21.090371+08:00&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>该 <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index.yaml</span><br></pre></td></tr></table></figure><br> 文件是我们通过仓库获取 Chart 包的关键。然后将代码推送到 GitHub：<p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">  ➜ git status</span><br><span class="line">On branch main</span><br><span class="line">Your branch is up to date with <span class="string">&#x27;origin/main&#x27;</span>.</span><br><span class="line"></span><br><span class="line">Untracked files:</span><br><span class="line">  (use <span class="string">&quot;git add &lt;file&gt;...&quot;</span> to include in what will be committed)</span><br><span class="line"></span><br><span class="line">        charts/</span><br><span class="line">        repo/</span><br><span class="line"></span><br><span class="line">nothing added to commit but untracked files <span class="title function_">present</span> <span class="params">(use <span class="string">&quot;git add&quot;</span> to track)</span></span><br><span class="line">➜ git commit -m <span class="string">&quot;add charts and index.yaml&quot;</span></span><br><span class="line">[main aae1059] add charts and index.yaml</span><br><span class="line"> <span class="number">11</span> files changed, <span class="number">431</span> insertions(+)</span><br><span class="line"> create mode <span class="number">100644</span> charts/my-ghost/.helmignore</span><br><span class="line"> create mode <span class="number">100644</span> charts/my-ghost/Chart.lock</span><br><span class="line"> create mode <span class="number">100644</span> charts/my-ghost/Chart.yaml</span><br><span class="line"> create mode <span class="number">100644</span> charts/my-ghost/templates/_helpers.tpl</span><br><span class="line"> create mode <span class="number">100644</span> charts/my-ghost/templates/deployment.yaml</span><br><span class="line"> create mode <span class="number">100644</span> charts/my-ghost/templates/ingress.yaml</span><br><span class="line"> create mode <span class="number">100644</span> charts/my-ghost/templates/pvc.yaml</span><br><span class="line"> create mode <span class="number">100644</span> charts/my-ghost/templates/service.yaml</span><br><span class="line"> create mode <span class="number">100644</span> charts/my-ghost/values.yaml</span><br><span class="line"> create mode <span class="number">100644</span> repo/stable/index.yaml</span><br><span class="line"> create mode <span class="number">100644</span> repo/stable/my-ghost-<span class="number">0.1</span><span class="number">.0</span>.tgz</span><br><span class="line">➜ git push origin main</span><br><span class="line">Enumerating objects: <span class="number">18</span>, done.</span><br><span class="line">Counting objects: <span class="number">100</span>% (<span class="number">18</span>/<span class="number">18</span>), done.</span><br><span class="line">Writing objects: <span class="number">100</span>% (<span class="number">18</span>/<span class="number">18</span>), <span class="number">8.71</span> KiB | <span class="number">2.18</span> MiB/s, done.</span><br><span class="line">Total <span class="number">18</span> (delta <span class="number">0</span>), reused <span class="number">0</span> (delta <span class="number">0</span>)</span><br><span class="line">To github.com:cnych/helm101.git</span><br><span class="line">   9c389a6..aae1059  main -&gt; main</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>接下来为该仓库设置 GitHub Pages，首先在本地新建一个 <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gh-pages</span><br></pre></td></tr></table></figure><br> 分支：<p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜ git checkout -b gh-pages</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>只将 <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">repo/stable/index.yaml</span><br></pre></td></tr></table></figure><br> 文件保留到根目录下面，其他文件忽略，然后推送到远程仓库：<p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">  ➜ git push origin gh-pages</span><br><span class="line">Enumerating objects: <span class="number">2</span>, done.</span><br><span class="line">Counting objects: <span class="number">100</span>% (<span class="number">2</span>/<span class="number">2</span>), done.</span><br><span class="line">Writing objects: <span class="number">100</span>% (<span class="number">2</span>/<span class="number">2</span>), <span class="number">301</span> bytes | <span class="number">301.00</span> KiB/s, done.</span><br><span class="line">Total <span class="number">2</span> (delta <span class="number">0</span>), reused <span class="number">0</span> (delta <span class="number">0</span>)</span><br><span class="line">remote:</span><br><span class="line">remote: Create a pull request <span class="keyword">for</span> <span class="string">&#x27;gh-pages&#x27;</span> on GitHub by visiting:</span><br><span class="line">remote:      https:<span class="comment">//github.com/cnych/helm101/pull/new/gh-pages</span></span><br><span class="line">remote:</span><br><span class="line">To github.com:cnych/helm101.git</span><br><span class="line"> * [<span class="keyword">new</span> <span class="title class_">branch</span>]      gh-pages -&gt; gh-pages</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在 GitHub Pages 页面选择使用 <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gh-pages</span><br></pre></td></tr></table></figure><br> 分支即可：<p></p><p>pages<br>现在我们就可以通过 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://cnych.github.io/helm101/">https://cnych.github.io/helm101/</a> 来获取我们的 Chart 包了。<br>使用如下所示命令添加 repo 仓库：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  ➜ helm repo add helm101 https:<span class="comment">//cnych.github.io/helm101/</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;helm101&quot;</span> has been added to your repositories</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我们也可以使用 <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm search</span><br></pre></td></tr></table></figure><br> 来搜索仓库中的 Chart 包，正常就包含上面我们的 <br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">my-ghost</span><br></pre></td></tr></table></figure><br> 了：<p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  ➜ helm search repo helm101</span><br><span class="line">NAME                    CHART VERSION   APP VERSION     DESCRIPTION</span><br><span class="line">helm101/my-ghost        <span class="number">0.1</span><span class="number">.0</span>           <span class="number">1.16</span><span class="number">.0</span>          A Helm chart <span class="keyword">for</span> Kubernetes</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>接下来就可以正常使用 chart 包进行操作了，比如进行安装：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ helm install my-ghost helm101/</span><br></pre></td></tr></table></figure><div class="post-copyright"><div class="content"><p>本文标题： 推荐系列-Helm Charts 开发完整示例</p><p>本文作者： OSChina</p><p>发布时间： 2022年03月27日 11:56</p><p>最后更新： 2022年05月11日 17:37</p><p>原始链接： <a class="post-url" href="/63833af1/" title="推荐系列-Helm Charts 开发完整示例">https://www.hosiang.cn/63833af1/</a></p><p>版权声明： 本文著作权归作者所有，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank">CC BY-NC-SA 4.0</a>许可协议，转载请注明出处！</p><footer><a href="https://www.hosiang.cn"><img src="/../images/logo.png" alt="Howe Hsiang"> Howe Hsiang</a></footer></div></div><div class="page-reward"><a id="rewardBtn" href="javascript:;">赏</a></div><div id="reward" class="post-modal reward-lay"><a class="close" href="javascript:;" id="reward-close">×</a> <span class="reward-title"><i class="icon icon-quote-left"></i> 喜欢就赞赏一下呗！ <i class="icon icon-quote-right"></i></span><div class="reward-content"><div class="reward-code"><img id="rewardCode" src="/images/threepay_code.jpg" alt="打赏二维码"></div><div class="reward-select"></div></div></div></div><footer class="article-footer"><div class="post-share"><a href="javascript:" id="share-sub" class="post-share-fab"><i class="fa fa-share-alt" style="padding-top:11px!important"></i></a><div class="post-share-list" id="share-list"><ul class="share-icons"><li><a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://www.hosiang.cn/63833af1/" data-title="Facebook" rel="external nofollow noopener noreferrer"><i class="fa fa-facebook" style="padding-top:9px!important"></i></a></li><li><a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《推荐系列-Helm Charts 开发完整示例》 — 狂欢马克思&url=https://www.hosiang.cn/63833af1/&via=https://www.hosiang.cn" data-title="Twitter" rel="external nofollow noopener noreferrer"><i class="fa fa-twitter" style="padding-top:9px!important"></i></a></li><li><a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://www.hosiang.cn/63833af1/" data-title="Google+" rel="external nofollow noopener noreferrer"><i class="fa fa-google-plus" style="padding-top:9px!important"></i></a></li><li><a class="qq share-sns" target="_blank" href="https://connect.qq.com/widget/shareqq/index.html?url=https://www.hosiang.cn/63833af1/&title=《推荐系列-Helm Charts 开发完整示例》 — 狂欢马克思&source=&amp;emsp;&amp;emsp;lm 的使用是比较简单的，但是要让我们自己开发一个 Chart 包还是有不小难度的，主要还是 go templat..." data-title="QQ" rel="external nofollow noopener noreferrer"><i class="fa fa-qq" style="padding-top:9px!important"></i></a></li><li><a class="weixin share-sns" id="wxFab" href="javascript:" data-title="微信"><i class="fa fa-weixin" style="padding-top:9px!important"></i></a></li><li><a class="weibo share-sns" target="_blank" href="https://service.weibo.com/share/share.php?url=https://www.hosiang.cn/63833af1/&title=《推荐系列-Helm Charts 开发完整示例》 — 狂欢马克思&pic=https://oscimg.oschina.net/oscnet/up-e3ab6bbc35c7e6f83757ca90c5c57943a9e.png" data-title="微博" rel="external nofollow noopener noreferrer"><i class="fa fa-weibo" style="padding-top:9px!important"></i></a></li></ul></div></div><div class="post-modal wx-share" id="wxShare"><a class="close" href="javascript:" id="wxShare-close">×</a><p>扫一扫，分享到微信</p><img src="//api.qrserver.com/v1/create-qr-code/?data=https://www.hosiang.cn/63833af1/" alt="微信分享二维码"></div><div class="mask"></div><ul class="article-footer-menu"><li class="article-footer-tags"><i class="fa fa-tags"></i> <a href="/tags/Popular/" class="color3">Popular</a></li></ul></footer></div></article><aside class="post-toc-pos post-toc-top" id="post-toc"><nav class="post-toc-wrap"><ol class="post-toc"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%BA%94%E7%94%A8"><span class="post-toc-text">应用</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%9F%BA%E7%A1%80%E6%A8%A1%E6%9D%BF"><span class="post-toc-text">基础模板</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%91%BD%E5%90%8D%E6%A8%A1%E6%9D%BF"><span class="post-toc-text">命名模板</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E7%89%88%E6%9C%AC%E5%85%BC%E5%AE%B9"><span class="post-toc-text">版本兼容</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96"><span class="post-toc-text">持久化</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%AE%9A%E5%88%B6"><span class="post-toc-text">定制</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%85%B1%E4%BA%AB-Charts"><span class="post-toc-text">共享 Charts</span></a></li></ol></nav></aside><nav id="article-nav"><a href="/a288ecc/" id="article-nav-newer" class="article-nav-link-wrap"><span class="article-nav-title"><i class="fa fa-hand-o-left" aria-hidden="true"></i> 推荐系列-CSI 工作原理与JuiceFS CSI Driver 的架构设计详解 </span></a><a href="/ba6658f3/" id="article-nav-older" class="article-nav-link-wrap"><span class="article-nav-title">推荐系列-MASA Blazor入门这一篇就够了</span> <i class="fa fa-hand-o-right" aria-hidden="true"></i></a></nav><div id="gitalk"></div><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script>var gitalk=new Gitalk({repo:"bolg-comment",owner:"Hosiang1026",admin:"Hosiang1026",clientID:"37a2dd4473e8970cecc2",clientSecret:"e30efa17d86d9de4f4ab810872dc62a7b2e7e634",pagerDirection:"last",distractionFreeMode:!0,createIssueManually:!1});gitalk.render("gitalk")</script></section></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner"><script id="_wau78w">var _wau=_wau||[];_wau.push(["small","5dnguv4c2n","78w"])</script><script async src="//waust.at/s.js"></script><p><span id="busuanzi_container_site_uv" style="display:none"><span class="post-count">总字数：<span>1781.1k</span> </span>总访客数：<span id="busuanzi_value_site_uv"></span> </span><span id="busuanzi_container_site_pv" style="display:none">总访问量：<span id="busuanzi_value_site_pv"></span></span><br><span id="TimeShow">本站</span><span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span><br>Copyright&copy; 2018 - 2022 狂欢马克思 <a href="https://beian.miit.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">京ICP备17060439号</a></p></div></div><script>var now=new Date;function createtime(){var n=new Date("2017/09/18");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="安全运行 "+dnum+" 天 ",document.getElementById("times").innerHTML=hnum+" 小时 "+mnum+" 分 "+snum+" 秒"}setInterval("createtime()",800)</script></footer><script>var mihoConfig={root:"https://www.hosiang.cn",animate:"true",isHome:"false",share:"true",reward:" 1"}</script><div class="sidebar"><div id="sidebar-search" title="Search"><i class="fa fa-search"></i></div><div id="sidebar-category" title="Categories"><i class="fa fa-book"></i></div><div id="sidebar-tag" title="Tags"><i class="fa fa-tags"></i></div><div id="sidebar-top"><span class="sidebar-top-icon"><i class="fa fa-angle-up"></i></span></div></div><div class="sidebar-menu-box" id="sidebar-menu-box"><div class="sidebar-menu-box-container"><div id="sidebar-menu-box-categories"><a class="category-link" href="/categories/%E5%85%B4%E8%B6%A3%E7%88%B1%E5%A5%BD/">兴趣爱好</a><a class="category-link" href="/categories/%E5%85%B6%E4%BB%96%E5%BC%80%E5%8F%91/">其他开发</a><a class="category-link" href="/categories/%E5%89%8D%E6%B2%BF%E5%BC%80%E5%8F%91/">前沿开发</a><a class="category-link" href="/categories/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/">前端开发</a><a class="category-link" href="/categories/%E5%8D%87%E7%BA%A7%E7%89%88%E6%9C%AC/">升级版本</a><a class="category-link" href="/categories/%E5%8D%9A%E5%AE%A2%E6%95%99%E7%A8%8B/">博客教程</a><a class="category-link" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a><a class="category-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a><a class="category-link" href="/categories/%E6%97%A5%E5%B8%B8%E8%AE%B0%E5%BD%95/">日常记录</a><a class="category-link" href="/categories/%E7%83%AD%E9%97%A8%E6%96%87%E7%AB%A0/">热门文章</a></div><div id="sidebar-menu-box-tags"><a href="/tags/Ajax/" style="font-size:10px">Ajax</a> <a href="/tags/AliGenie/" style="font-size:10px">AliGenie</a> <a href="/tags/Alipay/" style="font-size:10px">Alipay</a> <a href="/tags/Android/" style="font-size:10px">Android</a> <a href="/tags/Blockchain/" style="font-size:17.5px">Blockchain</a> <a href="/tags/CQRS/" style="font-size:10px">CQRS</a> <a href="/tags/Database/" style="font-size:15px">Database</a> <a href="/tags/Docker/" style="font-size:10px">Docker</a> <a href="/tags/EasyUI/" style="font-size:10px">EasyUI</a> <a href="/tags/Guitar/" style="font-size:10px">Guitar</a> <a href="/tags/Hackintosh/" style="font-size:12.5px">Hackintosh</a> <a href="/tags/Hexo/" style="font-size:15px">Hexo</a> <a href="/tags/IntelliJ-IDEA/" style="font-size:10px">IntelliJ IDEA</a> <a href="/tags/Java/" style="font-size:12.5px">Java</a> <a href="/tags/Kali-Linux/" style="font-size:10px">Kali Linux</a> <a href="/tags/Life/" style="font-size:17.5px">Life</a> <a href="/tags/Mac-OS/" style="font-size:12.5px">Mac OS</a> <a href="/tags/MultiThread/" style="font-size:10px">MultiThread</a> <a href="/tags/NodeJS/" style="font-size:10px">NodeJS</a> <a href="/tags/Popular/" style="font-size:20px">Popular</a> <a href="/tags/Python/" style="font-size:10px">Python</a> <a href="/tags/SaaS/" style="font-size:10px">SaaS</a> <a href="/tags/Servlet/" style="font-size:10px">Servlet</a> <a href="/tags/Spring/" style="font-size:17.5px">Spring</a> <a href="/tags/Upgrade/" style="font-size:10px">Upgrade</a> <a href="/tags/Web/" style="font-size:10px">Web</a> <a href="/tags/Windows/" style="font-size:10px">Windows</a> <a href="/tags/Work/" style="font-size:10px">Work</a> <a href="/tags/iOS/" style="font-size:10px">iOS</a></div></div><a href="javascript:" class="sidebar-menu-box-close">&times;</a></div><div class="mobile-header-menu-nav" id="mobile-header-menu-nav"><div class="mobile-header-menu-container"><span class="title">导航</span><ul class="mobile-header-menu-navbar"><li><a href="/"><i class="fa fa-home"></i><span>主页</span></a></li><li><a href="/archives"><i class="fa fa-archive"></i><span>归档</span></a></li><li><a href="/gitbook"><i class="fa fa-columns"></i><span>笔记</span></a></li><li><a href="/music"><i class="fa fa-music"></i><span>音乐</span></a></li><li><a href="/photo"><i class="fa fa-picture-o"></i><span>相册</span></a></li><li><a href="/collection"><i class="fa fa-envira"></i><span>收藏</span></a></li><li><a href="/about"><i class="fa fa-user"></i><span>关于</span></a></li></ul></div><div class="mobile-header-tag-container"><span class="title">标签</span><div id="mobile-header-container-tags"><a href="/tags/Ajax/" style="font-size:10px">Ajax</a> <a href="/tags/AliGenie/" style="font-size:10px">AliGenie</a> <a href="/tags/Alipay/" style="font-size:10px">Alipay</a> <a href="/tags/Android/" style="font-size:10px">Android</a> <a href="/tags/Blockchain/" style="font-size:17.5px">Blockchain</a> <a href="/tags/CQRS/" style="font-size:10px">CQRS</a> <a href="/tags/Database/" style="font-size:15px">Database</a> <a href="/tags/Docker/" style="font-size:10px">Docker</a> <a href="/tags/EasyUI/" style="font-size:10px">EasyUI</a> <a href="/tags/Guitar/" style="font-size:10px">Guitar</a> <a href="/tags/Hackintosh/" style="font-size:12.5px">Hackintosh</a> <a href="/tags/Hexo/" style="font-size:15px">Hexo</a> <a href="/tags/IntelliJ-IDEA/" style="font-size:10px">IntelliJ IDEA</a> <a href="/tags/Java/" style="font-size:12.5px">Java</a> <a href="/tags/Kali-Linux/" style="font-size:10px">Kali Linux</a> <a href="/tags/Life/" style="font-size:17.5px">Life</a> <a href="/tags/Mac-OS/" style="font-size:12.5px">Mac OS</a> <a href="/tags/MultiThread/" style="font-size:10px">MultiThread</a> <a href="/tags/NodeJS/" style="font-size:10px">NodeJS</a> <a href="/tags/Popular/" style="font-size:20px">Popular</a> <a href="/tags/Python/" style="font-size:10px">Python</a> <a href="/tags/SaaS/" style="font-size:10px">SaaS</a> <a href="/tags/Servlet/" style="font-size:10px">Servlet</a> <a href="/tags/Spring/" style="font-size:17.5px">Spring</a> <a href="/tags/Upgrade/" style="font-size:10px">Upgrade</a> <a href="/tags/Web/" style="font-size:10px">Web</a> <a href="/tags/Windows/" style="font-size:10px">Windows</a> <a href="/tags/Work/" style="font-size:10px">Work</a> <a href="/tags/iOS/" style="font-size:10px">iOS</a></div></div></div><div class="search-wrap"><span class="search-close">&times;</span> <a href="javascript:" class="header-icon waves-effect waves-circle waves-light" id="back"><i class="icon icon-lg icon-chevron-left"></i> </a><input class="search-field" placeholder="Search..." id="keywords"> <a id="search-submit" href="javascript:"><i class="fa fa-search"></i></a><div class="search-container" id="search-container"><ul class="search-result" id="search-result"></ul></div></div><div id="search-tpl"><li class="search-result-item"><a href="{url}" class="search-item-li"><span class="search-item-li-title" title="{title}">{title}</span></a></li></div><script src="/js/search.js"></script><script src="/js/main.js"></script><script src="//cdn.bootcss.com/particles.js/2.0.0/particles.min.js"></script><div id="particles"></div><script src="/js/particles.js"></script><link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css"><script src="//cdn.bootcss.com/scrollReveal.js/3.0.5/scrollreveal.js"></script><script src="/js/animate.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/hijiki.model.json"},display:{position:"right",width:150,height:300},mobile:{show:!0,scale:.5},log:!1})</script></body></html>