<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="Access-Control-Allow-Origin" content="*"><script type="text/javascript">var start_time=(new Date).getTime()</script><meta http-equiv="Cache-Control" content="no-cache"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="google-site-verification" content="9Wt3lmnrT2bfjaHla5s16adhvcQcBHO7PtNf97n5Od0"><meta name="baidu-site-verification" content="RYlYHsgO7Y"><meta name="sogou_site_verification" content="MSmrTj7lHV"><meta name="shenma-site-verification" content="e4428ccce0f22fad61c3716193bf4bd7_1571416388"><meta name="baidu_union_verify" content="584bb6b4bd24108df082b6d20c7aa9be"><title>推荐系列-解Bug之路-Nginx 502 Bad Gateway | 狂欢马克思</title><meta name="keywords" content="分享技术经验与交流"><meta name="description" content="&amp;emsp;&amp;emsp;解Bug之路-Nginx 502 Bad Gateway 前言 事实证明，读过Linux内核源码确实有很大的好处，尤其在处理问题的时刻。当你看到报错的那一瞬间，就能把现象&#x2F;原因&#x2F;以及解决方案一股脑的在脑中闪现。甚…"><meta property="og:type" content="article"><meta property="og:title" content="推荐系列-解Bug之路-Nginx 502 Bad Gateway"><meta property="og:url" content="https://www.hosiang.cn/8d0fdbfb/index.html"><meta property="og:site_name" content="狂欢马克思"><meta property="og:description" content="&amp;emsp;&amp;emsp;解Bug之路-Nginx 502 Bad Gateway 前言 事实证明，读过Linux内核源码确实有很大的好处，尤其在处理问题的时刻。当你看到报错的那一瞬间，就能把现象&#x2F;原因&#x2F;以及解决方案一股脑的在脑中闪现。甚…"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png"><meta property="og:image" content="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png"><meta property="og:image" content="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png"><meta property="og:image" content="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png"><meta property="og:image" content="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png"><meta property="og:image" content="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png"><meta property="og:image" content="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png"><meta property="og:image" content="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png"><meta property="og:image" content="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png"><meta property="og:image" content="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png"><meta property="og:image" content="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png"><meta property="og:image" content="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png"><meta property="og:image" content="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png"><meta property="og:image" content="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png"><meta property="og:image" content="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png"><meta property="og:image" content="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png"><meta property="og:image" content="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png"><meta property="og:image" content="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png"><meta property="og:image" content="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png"><meta property="article:published_time" content="2021-04-15T01:19:21.000Z"><meta property="article:modified_time" content="2022-05-11T07:02:49.951Z"><meta property="article:author" content="Howe Hsiang"><meta property="article:tag" content="Popular"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png"><link rel="icon" href="/images/favicon.ico"><link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"><link href="https://cdn.bootcss.com/font-awesome-animation/0.1.0/font-awesome-animation.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/style.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script"),t=(e.src="https://hm.baidu.com/hm.js?3cd8fa109426bf3f10bd5c362175bace",document.getElementsByTagName("script")[0]);t.parentNode.insertBefore(e,t)}()</script><script></script><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><meta name="generator" content="Hexo 6.2.0"></head><script src="/js/jquery.min.js"></script><script src="/js/pace.min.js"></script><script src="/js/crypto-js.js"></script><script src="/js/cookie.js"></script><script src="/js/calendar.js"></script><script src="/js/festival.js"></script><script>getFestival()</script><body><script>window.onload=function(){document.getElementById("TimeShow").innerHTML="本站耗时 "+((new Date).getTime()-start_time)/1e3+" 秒 "}</script><div id="container"><header id="header"><div id="banner"></div><div id="header-outer"><div id="header-menu" class="header-menu-pos animated"><div class="header-menu-container"><a href="/" class="left"><span class="site-title">狂欢马克思</span></a><nav id="header-menu-nav" class="right"><a href="/" rel="external nofollow"><i class="fa fa-home"></i> <span>主页</span> </a><a href="/archives" rel="external nofollow"><i class="fa fa-archive"></i> <span>归档</span> </a><a href="/gitbook" rel="external nofollow"><i class="fa fa-columns"></i> <span>笔记</span> </a><a href="/music" rel="external nofollow"><i class="fa fa-music"></i> <span>音乐</span> </a><a href="/photo" rel="external nofollow"><i class="fa fa-picture-o"></i> <span>相册</span> </a><a href="/collection" rel="external nofollow"><i class="fa fa-envira"></i> <span>收藏</span> </a><a href="/about" rel="external nofollow"><i class="fa fa-user"></i> <span>关于</span></a></nav><a class="mobile-header-menu-button"><i class="fa fa-bars"></i></a></div></div><div id="header-row"><div id="logo"><a href="/"><img src="/../images/logo.png" alt="logo"></a></div><div class="header-info"><div id="header-title"><h2>狂欢马克思</h2></div><div id="header-description"><h3>专注Web开发</h3></div></div><nav class="header-nav"><div class="social"><a title="Github" target="_blank" href="//github.com/Hosiang1026" rel="external nofollow"><i class="fa fa-github fa-2x"></i></a> <a title="QQ" target="_blank" href="//wpa.qq.com/msgrd?v=3&uin=641904695&site=qq&menu=yes" rel="external nofollow"><i class="fa fa-qq fa-2x"></i></a> <a title="Weibo" target="_blank" href="//www.weibo.com/haoxiang969" rel="external nofollow"><i class="fa fa-weibo fa-2x"></i></a></div></nav></div><div id="noticeId" class="show" style="background:rgb(244,247,247,.3)"><marquee id="noticeMar" behavior="scoll" class="notice" direction="left" onmouseover="this.stop()" onmouseout="this.start()"></marquee></div><script type="text/javascript">function browserRedirect(){var i=navigator.userAgent.toLowerCase(),n="ipad"==i.match(/ipad/i),o="iphone os"==i.match(/iphone os/i),a="midp"==i.match(/midp/i),t="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),e="ucweb"==i.match(/ucweb/i),s="android"==i.match(/android/i),d="windows ce"==i.match(/windows ce/i),i="windows mobile"==i.match(/windows mobile/i),p="",r=randomColor(),p=n||o||a||t||e||s||d||i?($("#noticeId").css({"line-height":"1.6em"}),"<font style='color:"+r+"' face='新华宋体'  size='2'>官宣：<span id='weekend'></span><span id='msg'></span><span id='timer'></span><span id='hitokoto'></span></span></span><span id='YQData'></font> "):($("#noticeId").css({"line-height":"3.6em","margin-top":"20px"}),"<font style='color:"+r+"' face='新华宋体'  size='6'>官宣：<span id='weekend'></span><span id='msg'></span><span id='timer'></span><span id='hitokoto'></span></span><span id='YQData'></span></font> ");$("#noticeMar").html(p)}function randomColor(){for(var i="0,1,2,3,4,5,6,7,8,9,a,b,c,d,e,f".split(","),n="#",o=0;o<6;o++)n+=i[Math.floor(16*Math.random())];return n}$(function(){browserRedirect(),0<$("#hitokoto").length&&getHitokoto()})</script></div></header><script>console.log=function(){}</script><div class="outer"><section id="main" class="body-wrap"><article id="post-解Bug之路-Nginx 502 Bad Gateway " class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 class="post-title" itemprop="name">推荐系列-解Bug之路-Nginx 502 Bad Gateway</h1><div class="post-title-bar"><ul><li><i class="fa fa-book"></i> <a href="/categories/热门文章/">热门文章</a></li><li><i class="fa fa-calendar"></i> 2021-04-15</li><li><i class="fa fa-eye"></i> <span id="busuanzi_value_page_pv"></span></li><li><span class="post-count">字数统计: 2.6k字</span></li><li><span class="post-count">阅读时长: 9分钟</span></li></ul></div></header><div class="article-entry post-content" itemprop="articleBody"><p>&amp;emsp;&amp;emsp;解Bug之路-Nginx 502 Bad Gateway 前言 事实证明，读过Linux内核源码确实有很大的好处，尤其在处理问题的时刻。当你看到报错的那一瞬间，就能把现象&#x2F;原因&#x2F;以及解决方案一股脑的在脑中闪现。甚…</p><span id="more"></span><pre><code>                                                                                                                                                                                    ### 解Bug之路-Nginx 502 Bad Gateway 
</code></pre><h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>事实证明，读过Linux内核源码确实有很大的好处，尤其在处理问题的时刻。当你看到报错的那一瞬间，就能把现象&#x2F;原因&#x2F;以及解决方案一股脑的在脑中闪现。甚至一些边边角角的现象都能很快的反应过来是为何。笔者读过一些Linux TCP协议栈的源码，就在解决下面这个问题的时候有一种非常流畅的感觉。</p><h4 id="Bug现场"><a href="#Bug现场" class="headerlink" title="Bug现场"></a>Bug现场</h4><p>首先，这个问题其实并不难解决，但是这个问题引发的现象倒是挺有意思。先描述一下现象吧， 笔者要对自研的dubbo协议隧道网关进行压测(这个网关的设计也挺有意思，准备放到后面的博客里面)。先看下压测的拓扑吧: <img src="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png" alt="Test" title="解Bug之路-Nginx 502 Bad Gateway "> 为了压测笔者gateway的单机性能，两端仅仅各保留一台网关，即gateway1和gateway2。压到一定程度就开始报错，导致压测停止。很自然的就想到，网关扛不住了。</p><h4 id="网关的情况"><a href="#网关的情况" class="headerlink" title="网关的情况"></a>网关的情况</h4><p>去Gateway2的机器上看了一下，没有任何报错。而Gateway1则有大量的502报错。502是Bad Gateway，Nginx的经典报错，首先想到的就是Gateway2不堪重负被Nginx在Upstream中踢掉。 <img src="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png" alt="Test" title="解Bug之路-Nginx 502 Bad Gateway "> 那么，就先看看Gateway2的负载情况把，查了下监控，发现Gateway2在4核8G的机器上只用了一个核，完全看不出来有瓶颈的样子，难道是IO有问题？看了下小的可怜的网卡流量打消了这个猜想。</p><h4 id="Nginx所在机器CPU利用率接近100"><a href="#Nginx所在机器CPU利用率接近100" class="headerlink" title="Nginx所在机器CPU利用率接近100%"></a>Nginx所在机器CPU利用率接近100%</h4><p>这时候，发现一个有意思的现象,Nginx确用满了CPU! <img src="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png" alt="Test" title="解Bug之路-Nginx 502 Bad Gateway "> 再次压测，去Nginx所在机器上top了一下，发现Nginx的4个Worker分别占了一个核把CPU吃满-_-! <img src="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png" alt="Test" title="解Bug之路-Nginx 502 Bad Gateway "> 什么，号称性能强悍的Nginx竟然这么弱，说好的事件驱动\epoll边沿触发\纯C打造的呢？一定是用的姿势不对！</p><h4 id="去掉Nginx直接通信毫无压力"><a href="#去掉Nginx直接通信毫无压力" class="headerlink" title="去掉Nginx直接通信毫无压力"></a>去掉Nginx直接通信毫无压力</h4><p>既然猜测是Nginx的瓶颈,就把Nginx去掉吧。Gateway1和Gateway2直连，压测TPS���面就飙升了，而且Gateway2的CPU最多也就吃了2个核，毫无压力。 <img src="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png" alt="Test" title="解Bug之路-Nginx 502 Bad Gateway "></p><h4 id="去Nginx上看下日志"><a href="#去Nginx上看下日志" class="headerlink" title="去Nginx上看下日志"></a>去Nginx上看下日志</h4><p>由于Nginx机器权限并不在笔者手上，所以一开始没有关注其日志，现在就联系一下对应的运维去看一下吧。在accesslog里面发现了大量的502报错，确实是Nginx的。又看了下错误日志，发现有大量的</p><pre><code class="java"> Cannot assign requested address
</code></pre><p>由于笔者读过TCP源码，一瞬间就反应过来，是端口号耗尽了！由于Nginx upstream和后端Backend默认是短连接，所以在大量请求流量进来的时候回产生大量TIME_WAIT的连接。 <img src="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png" alt="Test" title="解Bug之路-Nginx 502 Bad Gateway "> 而这些TIME_WAIT是占据端口号的，而且基本要1分钟左右才能被Kernel回收。 <img src="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png" alt="Test" title="解Bug之路-Nginx 502 Bad Gateway "></p><pre><code class="java"> cat /proc/sys/net/ipv4/ip_local_port_range
32768	61000
</code></pre><p>也就是说，只要一分钟之内产生28232(61000-32768)个TIME_WAIT的socket就会造成端口号耗尽，也即470.5TPS(28232&#x2F;60),只是一个很容易达到的压测值。事实上这个限制是Client端的,Server端没有这样的限制，因为Server端口号只有一个8080这样的有名端口号。而在 upstream中Nginx扮演的就是Client,而Gateway2就扮演的是Nginx <img src="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png" alt="Test" title="解Bug之路-Nginx 502 Bad Gateway "></p><h4 id="为什么Nginx的CPU是100"><a href="#为什么Nginx的CPU是100" class="headerlink" title="为什么Nginx的CPU是100%"></a>为什么Nginx的CPU是100%</h4><p>而笔者也很快想明白了Nginx为什么吃满了机器的CPU,问题就出来端口号的搜索过程。 <img src="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png" alt="Test" title="解Bug之路-Nginx 502 Bad Gateway "> 让我们看下最耗性能的一段函数:</p><pre><code class="java"> int __inet_hash_connect(...)
&#123;
       // 注意，这边是static变量
       static u32 hint;
       // hint有助于不从0开始搜索，而是从下一个待分配的端口号搜索
       u32 offset = hint + port_offset;
       .....
       inet_get_local_port_range(&amp;low, &amp;high);
       // 这边remaining就是61000 - 32768
       remaining = (high - low) + 1
       ......
       for (i = 1; i &lt;= remaining; i++) &#123;
           port = low + (i + offset) % remaining;
           /* port是否占用check */
           ....
           goto ok;
       &#125;
       .......
ok:
       hint += i;
       ......
&#125;
</code></pre><p>看上面那段代码，如果一直没有端口号可用的话，则需要循环remaining次才能宣告端口号耗尽，也就是28232次。而如果按照正常的情况，因为有hint的存在，所以每次搜索从下一个待分配的端口号开始计算，以个位数的搜索就能找到端口号。如下图所示: <img src="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png" alt="Test" title="解Bug之路-Nginx 502 Bad Gateway "> 所以当端口号耗尽后，Nginx的Worker进程就沉浸在上述for循环中不可自拔，把CPU吃满。 <img src="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png" alt="Test" title="解Bug之路-Nginx 502 Bad Gateway "></p><h4 id="为什么Gateway1调用Nginx没有问题"><a href="#为什么Gateway1调用Nginx没有问题" class="headerlink" title="为什么Gateway1调用Nginx没有问题"></a>为什么Gateway1调用Nginx没有问题</h4><p>很简单，因为笔者在Gateway1调用Nginx的时候设置了Keepalived，所以采用的是长连接，就没有这个端口号耗尽的限制。 <img src="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png" alt="Test" title="解Bug之路-Nginx 502 Bad Gateway "></p><h4 id="Nginx-后面有多台机器的话"><a href="#Nginx-后面有多台机器的话" class="headerlink" title="Nginx 后面有多台机器的话"></a>Nginx 后面有多台机器的话</h4><p>由于是因为端口号搜索导致CPU 100%,而且但凡有可用端口号，因为hint的原因，搜索次数可能就是1和28232的区别。 <img src="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png" alt="Test" title="解Bug之路-Nginx 502 Bad Gateway "> 因为端口号限制是针对某个特定的远端server:port的。 所以，只要Nginx的Backend有多台机器，甚至同一个机器上的多个不同端口号，只要不超过临界点，Nginx就不会有任何压力。 <img src="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png" alt="Test" title="解Bug之路-Nginx 502 Bad Gateway "></p><h4 id="把端口号范围调大"><a href="#把端口号范围调大" class="headerlink" title="把端口号范围调大"></a>把端口号范围调大</h4><p>比较无脑的方案当然是把端口号范围调大，这样就能抗更多的TIME_WAIT。同时将tcp_max_tw_bucket调小，tcp_max_tw_bucket是kernel中最多存在的TIME_WAIT数量，只要port范围 - tcp_max_tw_bucket大于一定的值，那么就始终有port端口可用，这样就可以避免再次到调大临界值得时候继续击穿临界点。</p><pre><code class="java"> cat /proc/sys/net/ipv4/ip_local_port_range
22768	61000
cat /proc/sys/net/ipv4/tcp_max_tw_buckets
20000
</code></pre><h4 id="开启tcp-tw-reuse"><a href="#开启tcp-tw-reuse" class="headerlink" title="开启tcp_tw_reuse"></a>开启tcp_tw_reuse</h4><p>这个问题Linux其实早就有了解决方案，那就是tcp_tw_reuse这个参数。</p><pre><code class="java"> echo &#39;1&#39; &gt; /proc/sys/net/ipv4/tcp_tw_reuse
</code></pre><p>事实上TIME_WAIT过多的原因是其回收时间竟然需要1min，这个1min其实是TCP协议中规定的2MSL时间，而Linux中就固定为1min。</p><pre><code class="java"> #define TCP_TIMEWAIT_LEN (60*HZ) /* how long to wait to destroy TIME-WAIT
                 * state, about 60 seconds	*/
</code></pre><p>2MSL的原因就是排除网络上还残留的包对新的同样的五元组的Socket产生影响，也就是说在2MSL(1min)之内重用这个五元组会有风险。为了解决这个问题，Linux就采取了一些列措施防止这样的情况，使得在大部分情况下1s之内的TIME_WAIT就可以重用。下面这段代码，就是检测此TIME_WAIT是否重用。</p><pre><code class="java"> __inet_hash_connect
   |-&gt;__inet_check_established
static int __inet_check_established(......)
&#123;
   ......	
   /* Check TIME-WAIT sockets first. */
   sk_nulls_for_each(sk2, node, &amp;head-&gt;twchain) &#123;
       tw = inet_twsk(sk2);
       // 如果在time_wait中找到一个match的port,就判断是否可重用
       if (INET_TW_MATCH(sk2, net, hash, acookie,
                   saddr, daddr, ports, dif)) &#123;
           if (twsk_unique(sk, sk2, twp))
               goto unique;
           else
               goto not_unique;
       &#125;
   &#125;
   ......
&#125;
</code></pre><p>而其中的核心函数就是twsk_unique，它的判断逻辑如下:</p><pre><code class="java"> int tcp_twsk_unique(......)
&#123;
   ......
   if (tcptw-&gt;tw_ts_recent_stamp &amp;&amp;
       (twp == NULL || (sysctl_tcp_tw_reuse &amp;&amp;
                get_seconds() - tcptw-&gt;tw_ts_recent_stamp &gt; 1))) &#123;
      // 对write_seq设置为snd_nxt+65536+2
      // 这样能够确保在数据传输速率&lt;=80Mbit/s的情况下不会被回绕      
       tp-&gt;write_seq = tcptw-&gt;tw_snd_nxt + 65535 + 2
       ......
       return 1;
   &#125;
   return 0;	
&#125;
</code></pre><p>上面这段代码逻辑如下所示: <img src="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png" alt="Test" title="解Bug之路-Nginx 502 Bad Gateway "> 在开启了tcp_timestamp以及tcp_tw_reuse的情况下,在Connect搜索port时只要比之前用这个port的TIME_WAIT状态的Socket记录的最近时间戳&gt;1s,就可以重用此port,即将之前的1分钟缩短到1s。同时为了防止潜在的序列号冲突，直接将write_seq加上在65537,这样，在单Socket传输速率小于80Mbit&#x2F;s的情况下，不会造成序列号重叠(冲突)。 同时这个tw_ts_recent_stamp设置的时机如下图所示: <img src="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png" alt="Test" title="解Bug之路-Nginx 502 Bad Gateway "> 所以如果Socket进入TIME_WAIT状态后，如果一直有对应的包发过来，那么会影响此TIME_WAIT对应的port是否可用的时间。 开启了这个参数之后,由于从1min缩短到1s,那么Nginx单台对单Upstream可承受的TPS就从原来的470.5TPS(28232&#x2F;60)一跃提升为28232TPS，增长了60倍。 如果还嫌性能不够，可以配上上面的端口号范围调大以及tcp_max_tw_bucket调小继续提升tps,不过tcp_max_tw_bucket调小可能会有序列号重叠的风险，毕竟Socket不经过2MSL阶段就被重用了。</p><h4 id="不要开启tcp-tw-recycle"><a href="#不要开启tcp-tw-recycle" class="headerlink" title="不要开启tcp_tw_recycle"></a>不要开启tcp_tw_recycle</h4><p>开启tcp_tw_recyle这个参数会在NAT环境下造成很大的影响，建议不开启，具体见笔者的另一篇博客:</p><pre><code class="java"> https://my.oschina.net/alchemystar/blog/3119992
</code></pre><h3 id="Nginx-upstream改成长连接"><a href="#Nginx-upstream改成长连接" class="headerlink" title="Nginx upstream改成长连接"></a>Nginx upstream改成长连接</h3><p>事实上，上面的一系列问题都是由于Nginx对Backend是短连接导致。 Nginx从 1.1.4 开始，实现了对后端机器的长连接支持功能。在Upstream中这样配置可以开启长连接的功能:</p><pre><code class="java"> upstream backend &#123;
   server 127.0.0.1:8080;
# It should be particularly noted that the keepalive directive does not limit the total number of connections to upstream servers that an nginx worker         	process can open. The connections parameter should be set to a number small enough to let upstream servers process new incoming connections as 	well.
   keepalive 32; 
   keepalive_timeout 30s; # 设置后端连接的最大idle时间为30s
&#125;
</code></pre><p>这样前端和后端都是长连接，大家又可以愉快的玩耍了。 <img src="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png" alt="Test" title="解Bug之路-Nginx 502 Bad Gateway "></p><h3 id="由此产生的风险点"><a href="#由此产生的风险点" class="headerlink" title="由此产生的风险点"></a>由此产生的风险点</h3><p>由于对单个远端ip:port耗尽会导致CPU吃满这种现象。所以在Nginx在配置Upstream时候需要格外小心。假设一种情况，PE扩容了一台Nginx,为防止有问题，就先配一台Backend看看情况，这时候如果量比较大的话击穿临界点就会造成大量报错(而应用本身确毫无压力，毕竟临界值是470.5TPS(28232&#x2F;60))，甚至在同Nginx上的非此域名的请求也会因为CPU被耗尽而得不到响应。多配几台Backend&#x2F;开启tcp_tw_reuse或许是不错的选择。</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>应用再强大也还是承载在内核之上，始终逃不出Linux内核的樊笼。所以对于Linux内核本身参数的调优还是非常有意义的。如果读过一些内核源码，无疑对我们排查线上问题有着很大的助力，同时也能指导我们避过一些坑！</p><h4 id="公众号"><a href="#公众号" class="headerlink" title="公众号"></a>公众号</h4><p>关注笔者公众号，获取更多干货文章，更有礼包相送^_^: <img src="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png" alt="Test" title="解Bug之路-Nginx 502 Bad Gateway "> <img src="https://oscimg.oschina.net/oscnet/up-cb1706f8f544254d756b32eee5c1aa35c91.png" alt="Test" title="解Bug之路-Nginx 502 Bad Gateway "></p><div class="post-copyright"><div class="content"><p>本文标题： 推荐系列-解Bug之路-Nginx 502 Bad Gateway</p><p>本文作者： OSChina</p><p>发布时间： 2021年04月15日 09:19</p><p>最后更新： 2022年05月11日 15:02</p><p>原始链接： <a class="post-url" href="/8d0fdbfb/" title="推荐系列-解Bug之路-Nginx 502 Bad Gateway">https://www.hosiang.cn/8d0fdbfb/</a></p><p>版权声明： 本文著作权归作者所有，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank">CC BY-NC-SA 4.0</a>许可协议，转载请注明出处！</p><footer><a href="https://www.hosiang.cn"><img src="/../images/logo.png" alt="Howe Hsiang"> Howe Hsiang</a></footer></div></div><div class="page-reward"><a id="rewardBtn" href="javascript:;">赏</a></div><div id="reward" class="post-modal reward-lay"><a class="close" href="javascript:;" id="reward-close">×</a> <span class="reward-title"><i class="icon icon-quote-left"></i> 喜欢就赞赏一下呗！ <i class="icon icon-quote-right"></i></span><div class="reward-content"><div class="reward-code"><img id="rewardCode" src="/images/threepay_code.jpg" alt="打赏二维码"></div><div class="reward-select"></div></div></div></div><footer class="article-footer"><div class="post-share"><a href="javascript:" id="share-sub" class="post-share-fab"><i class="fa fa-share-alt" style="padding-top:11px!important"></i></a><div class="post-share-list" id="share-list"><ul class="share-icons"><li><a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://www.hosiang.cn/8d0fdbfb/" data-title="Facebook" rel="external nofollow noopener noreferrer"><i class="fa fa-facebook" style="padding-top:9px!important"></i></a></li><li><a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《推荐系列-解Bug之路-Nginx 502 Bad Gateway》 — 狂欢马克思&url=https://www.hosiang.cn/8d0fdbfb/&via=https://www.hosiang.cn" data-title="Twitter" rel="external nofollow noopener noreferrer"><i class="fa fa-twitter" style="padding-top:9px!important"></i></a></li><li><a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://www.hosiang.cn/8d0fdbfb/" data-title="Google+" rel="external nofollow noopener noreferrer"><i class="fa fa-google-plus" style="padding-top:9px!important"></i></a></li><li><a class="qq share-sns" target="_blank" href="https://connect.qq.com/widget/shareqq/index.html?url=https://www.hosiang.cn/8d0fdbfb/&title=《推荐系列-解Bug之路-Nginx 502 Bad Gateway》 — 狂欢马克思&source=&amp;emsp;&amp;emsp;解Bug之路-Nginx 502 Bad Gateway 前言 事实证明，读过Linux内核源码确实有很大的好处，..." data-title="QQ" rel="external nofollow noopener noreferrer"><i class="fa fa-qq" style="padding-top:9px!important"></i></a></li><li><a class="weixin share-sns" id="wxFab" href="javascript:" data-title="微信"><i class="fa fa-weixin" style="padding-top:9px!important"></i></a></li><li><a class="weibo share-sns" target="_blank" href="https://service.weibo.com/share/share.php?url=https://www.hosiang.cn/8d0fdbfb/&title=《推荐系列-解Bug之路-Nginx 502 Bad Gateway》 — 狂欢马克思&pic=https://static.oschina.net/uploads/img/202008/20142307_EXMG.jpg" data-title="微博" rel="external nofollow noopener noreferrer"><i class="fa fa-weibo" style="padding-top:9px!important"></i></a></li></ul></div></div><div class="post-modal wx-share" id="wxShare"><a class="close" href="javascript:" id="wxShare-close">×</a><p>扫一扫，分享到微信</p><img src="//api.qrserver.com/v1/create-qr-code/?data=https://www.hosiang.cn/8d0fdbfb/" alt="微信分享二维码"></div><div class="mask"></div><ul class="article-footer-menu"><li class="article-footer-tags"><i class="fa fa-tags"></i> <a href="/tags/Popular/" class="color3">Popular</a></li></ul></footer></div></article><aside class="post-toc-pos post-toc-top" id="post-toc"><nav class="post-toc-wrap"><ol class="post-toc"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%89%8D%E8%A8%80"><span class="post-toc-text">前言</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Bug%E7%8E%B0%E5%9C%BA"><span class="post-toc-text">Bug现场</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E7%BD%91%E5%85%B3%E7%9A%84%E6%83%85%E5%86%B5"><span class="post-toc-text">网关的情况</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Nginx%E6%89%80%E5%9C%A8%E6%9C%BA%E5%99%A8CPU%E5%88%A9%E7%94%A8%E7%8E%87%E6%8E%A5%E8%BF%91100"><span class="post-toc-text">Nginx所在机器CPU利用率接近100%</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%8E%BB%E6%8E%89Nginx%E7%9B%B4%E6%8E%A5%E9%80%9A%E4%BF%A1%E6%AF%AB%E6%97%A0%E5%8E%8B%E5%8A%9B"><span class="post-toc-text">去掉Nginx直接通信毫无压力</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%8E%BBNginx%E4%B8%8A%E7%9C%8B%E4%B8%8B%E6%97%A5%E5%BF%97"><span class="post-toc-text">去Nginx上看下日志</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88Nginx%E7%9A%84CPU%E6%98%AF100"><span class="post-toc-text">为什么Nginx的CPU是100%</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88Gateway1%E8%B0%83%E7%94%A8Nginx%E6%B2%A1%E6%9C%89%E9%97%AE%E9%A2%98"><span class="post-toc-text">为什么Gateway1调用Nginx没有问题</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Nginx-%E5%90%8E%E9%9D%A2%E6%9C%89%E5%A4%9A%E5%8F%B0%E6%9C%BA%E5%99%A8%E7%9A%84%E8%AF%9D"><span class="post-toc-text">Nginx 后面有多台机器的话</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E6%8A%8A%E7%AB%AF%E5%8F%A3%E5%8F%B7%E8%8C%83%E5%9B%B4%E8%B0%83%E5%A4%A7"><span class="post-toc-text">把端口号范围调大</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%BC%80%E5%90%AFtcp-tw-reuse"><span class="post-toc-text">开启tcp_tw_reuse</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E4%B8%8D%E8%A6%81%E5%BC%80%E5%90%AFtcp-tw-recycle"><span class="post-toc-text">不要开启tcp_tw_recycle</span></a></li></ol><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Nginx-upstream%E6%94%B9%E6%88%90%E9%95%BF%E8%BF%9E%E6%8E%A5"><span class="post-toc-text">Nginx upstream改成长连接</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E7%94%B1%E6%AD%A4%E4%BA%A7%E7%94%9F%E7%9A%84%E9%A3%8E%E9%99%A9%E7%82%B9"><span class="post-toc-text">由此产生的风险点</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%80%BB%E7%BB%93"><span class="post-toc-text">总结</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%85%AC%E4%BC%97%E5%8F%B7"><span class="post-toc-text">公众号</span></a></li></ol></li></nav></aside><nav id="article-nav"><a href="/bd9cbc0f/" id="article-nav-newer" class="article-nav-link-wrap"><span class="article-nav-title"><i class="fa fa-hand-o-left" aria-hidden="true"></i> 推荐系列-自己实现一个RPC框架 </span></a><a href="/a655b046/" id="article-nav-older" class="article-nav-link-wrap"><span class="article-nav-title">推荐系列-解密飞桨多任务学习框架PALM，让你的模型开启-学霸-模式</span> <i class="fa fa-hand-o-right" aria-hidden="true"></i></a></nav><div id="gitalk"></div><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script>var gitalk=new Gitalk({repo:"bolg-comment",owner:"Hosiang1026",admin:"Hosiang1026",clientID:"37a2dd4473e8970cecc2",clientSecret:"e30efa17d86d9de4f4ab810872dc62a7b2e7e634",pagerDirection:"last",distractionFreeMode:!0,createIssueManually:!1});gitalk.render("gitalk")</script></section></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner"><script id="_wau78w">var _wau=_wau||[];_wau.push(["small","5dnguv4c2n","78w"])</script><script async src="//waust.at/s.js"></script><p><span id="busuanzi_container_site_uv" style="display:none"><span class="post-count">总字数：<span>1531.2k</span> </span>总访客数：<span id="busuanzi_value_site_uv"></span> </span><span id="busuanzi_container_site_pv" style="display:none">总访问量：<span id="busuanzi_value_site_pv"></span></span><br><span id="TimeShow">本站</span><span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span><br>Copyright&copy; 2018 - 2022 狂欢马克思 <a href="https://beian.miit.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">京ICP备17060439号</a></p></div></div><script>var now=new Date;function createtime(){var n=new Date("2017/09/18");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="安全运行 "+dnum+" 天 ",document.getElementById("times").innerHTML=hnum+" 小时 "+mnum+" 分 "+snum+" 秒"}setInterval("createtime()",800)</script></footer><script>var mihoConfig={root:"https://www.hosiang.cn",animate:"true",isHome:"false",share:"true",reward:" 1"}</script><div class="sidebar"><div id="sidebar-search" title="Search"><i class="fa fa-search"></i></div><div id="sidebar-category" title="Categories"><i class="fa fa-book"></i></div><div id="sidebar-tag" title="Tags"><i class="fa fa-tags"></i></div><div id="sidebar-top"><span class="sidebar-top-icon"><i class="fa fa-angle-up"></i></span></div></div><div class="sidebar-menu-box" id="sidebar-menu-box"><div class="sidebar-menu-box-container"><div id="sidebar-menu-box-categories"><a class="category-link" href="/categories/%E5%85%B4%E8%B6%A3%E7%88%B1%E5%A5%BD/">兴趣爱好</a><a class="category-link" href="/categories/%E5%85%B6%E4%BB%96%E5%BC%80%E5%8F%91/">其他开发</a><a class="category-link" href="/categories/%E5%89%8D%E6%B2%BF%E5%BC%80%E5%8F%91/">前沿开发</a><a class="category-link" href="/categories/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/">前端开发</a><a class="category-link" href="/categories/%E5%8D%87%E7%BA%A7%E7%89%88%E6%9C%AC/">升级版本</a><a class="category-link" href="/categories/%E5%8D%9A%E5%AE%A2%E6%95%99%E7%A8%8B/">博客教程</a><a class="category-link" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a><a class="category-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a><a class="category-link" href="/categories/%E6%97%A5%E5%B8%B8%E8%AE%B0%E5%BD%95/">日常记录</a><a class="category-link" href="/categories/%E7%83%AD%E9%97%A8%E6%96%87%E7%AB%A0/">热门文章</a></div><div id="sidebar-menu-box-tags"><a href="/tags/Ajax/" style="font-size:10px">Ajax</a> <a href="/tags/AliGenie/" style="font-size:10px">AliGenie</a> <a href="/tags/Alipay/" style="font-size:10px">Alipay</a> <a href="/tags/Android/" style="font-size:10px">Android</a> <a href="/tags/Blockchain/" style="font-size:17.5px">Blockchain</a> <a href="/tags/CQRS/" style="font-size:10px">CQRS</a> <a href="/tags/Database/" style="font-size:15px">Database</a> <a href="/tags/Docker/" style="font-size:10px">Docker</a> <a href="/tags/EasyUI/" style="font-size:10px">EasyUI</a> <a href="/tags/Guitar/" style="font-size:10px">Guitar</a> <a href="/tags/Hackintosh/" style="font-size:12.5px">Hackintosh</a> <a href="/tags/Hexo/" style="font-size:15px">Hexo</a> <a href="/tags/IntelliJ-IDEA/" style="font-size:10px">IntelliJ IDEA</a> <a href="/tags/Java/" style="font-size:12.5px">Java</a> <a href="/tags/Kali-Linux/" style="font-size:10px">Kali Linux</a> <a href="/tags/Life/" style="font-size:17.5px">Life</a> <a href="/tags/Mac-OS/" style="font-size:12.5px">Mac OS</a> <a href="/tags/MultiThread/" style="font-size:10px">MultiThread</a> <a href="/tags/NodeJS/" style="font-size:10px">NodeJS</a> <a href="/tags/Popular/" style="font-size:20px">Popular</a> <a href="/tags/Python/" style="font-size:10px">Python</a> <a href="/tags/SaaS/" style="font-size:10px">SaaS</a> <a href="/tags/Servlet/" style="font-size:10px">Servlet</a> <a href="/tags/Spring/" style="font-size:17.5px">Spring</a> <a href="/tags/Upgrade/" style="font-size:10px">Upgrade</a> <a href="/tags/Web/" style="font-size:10px">Web</a> <a href="/tags/Windows/" style="font-size:10px">Windows</a> <a href="/tags/Work/" style="font-size:10px">Work</a> <a href="/tags/iOS/" style="font-size:10px">iOS</a></div></div><a href="javascript:" class="sidebar-menu-box-close">&times;</a></div><div class="mobile-header-menu-nav" id="mobile-header-menu-nav"><div class="mobile-header-menu-container"><span class="title">导航</span><ul class="mobile-header-menu-navbar"><li><a href="/"><i class="fa fa-home"></i><span>主页</span></a></li><li><a href="/archives"><i class="fa fa-archive"></i><span>归档</span></a></li><li><a href="/gitbook"><i class="fa fa-columns"></i><span>笔记</span></a></li><li><a href="/music"><i class="fa fa-music"></i><span>音乐</span></a></li><li><a href="/photo"><i class="fa fa-picture-o"></i><span>相册</span></a></li><li><a href="/collection"><i class="fa fa-envira"></i><span>收藏</span></a></li><li><a href="/about"><i class="fa fa-user"></i><span>关于</span></a></li></ul></div><div class="mobile-header-tag-container"><span class="title">标签</span><div id="mobile-header-container-tags"><a href="/tags/Ajax/" style="font-size:10px">Ajax</a> <a href="/tags/AliGenie/" style="font-size:10px">AliGenie</a> <a href="/tags/Alipay/" style="font-size:10px">Alipay</a> <a href="/tags/Android/" style="font-size:10px">Android</a> <a href="/tags/Blockchain/" style="font-size:17.5px">Blockchain</a> <a href="/tags/CQRS/" style="font-size:10px">CQRS</a> <a href="/tags/Database/" style="font-size:15px">Database</a> <a href="/tags/Docker/" style="font-size:10px">Docker</a> <a href="/tags/EasyUI/" style="font-size:10px">EasyUI</a> <a href="/tags/Guitar/" style="font-size:10px">Guitar</a> <a href="/tags/Hackintosh/" style="font-size:12.5px">Hackintosh</a> <a href="/tags/Hexo/" style="font-size:15px">Hexo</a> <a href="/tags/IntelliJ-IDEA/" style="font-size:10px">IntelliJ IDEA</a> <a href="/tags/Java/" style="font-size:12.5px">Java</a> <a href="/tags/Kali-Linux/" style="font-size:10px">Kali Linux</a> <a href="/tags/Life/" style="font-size:17.5px">Life</a> <a href="/tags/Mac-OS/" style="font-size:12.5px">Mac OS</a> <a href="/tags/MultiThread/" style="font-size:10px">MultiThread</a> <a href="/tags/NodeJS/" style="font-size:10px">NodeJS</a> <a href="/tags/Popular/" style="font-size:20px">Popular</a> <a href="/tags/Python/" style="font-size:10px">Python</a> <a href="/tags/SaaS/" style="font-size:10px">SaaS</a> <a href="/tags/Servlet/" style="font-size:10px">Servlet</a> <a href="/tags/Spring/" style="font-size:17.5px">Spring</a> <a href="/tags/Upgrade/" style="font-size:10px">Upgrade</a> <a href="/tags/Web/" style="font-size:10px">Web</a> <a href="/tags/Windows/" style="font-size:10px">Windows</a> <a href="/tags/Work/" style="font-size:10px">Work</a> <a href="/tags/iOS/" style="font-size:10px">iOS</a></div></div></div><div class="search-wrap"><span class="search-close">&times;</span> <a href="javascript:" class="header-icon waves-effect waves-circle waves-light" id="back"><i class="icon icon-lg icon-chevron-left"></i> </a><input class="search-field" placeholder="Search..." id="keywords"> <a id="search-submit" href="javascript:"><i class="fa fa-search"></i></a><div class="search-container" id="search-container"><ul class="search-result" id="search-result"></ul></div></div><div id="search-tpl"><li class="search-result-item"><a href="{url}" class="search-item-li"><span class="search-item-li-title" title="{title}">{title}</span></a></li></div><script src="/js/search.js"></script><script src="/js/main.js"></script><script src="//cdn.bootcss.com/particles.js/2.0.0/particles.min.js"></script><div id="particles"></div><script src="/js/particles.js"></script><link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css"><script src="//cdn.bootcss.com/scrollReveal.js/3.0.5/scrollreveal.js"></script><script src="/js/animate.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/hijiki.model.json"},display:{position:"right",width:150,height:300},mobile:{show:!0,scale:.5},log:!1})</script></body></html>