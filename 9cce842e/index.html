<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="Access-Control-Allow-Origin" content="*"><script type="text/javascript">var start_time=(new Date).getTime()</script><meta http-equiv="Cache-Control" content="no-cache"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="google-site-verification" content="9Wt3lmnrT2bfjaHla5s16adhvcQcBHO7PtNf97n5Od0"><meta name="baidu-site-verification" content="RYlYHsgO7Y"><meta name="sogou_site_verification" content="MSmrTj7lHV"><meta name="shenma-site-verification" content="e4428ccce0f22fad61c3716193bf4bd7_1571416388"><meta name="baidu_union_verify" content="584bb6b4bd24108df082b6d20c7aa9be"><title>推荐系列-如何使用k3s+树莓派在生产中构建轻量K8S裸机集群 | 狂欢马克思</title><meta name="keywords" content="分享技术经验与交流"><meta name="description" content="&amp;emsp;&amp;emsp;Boogie Software是欧洲著名的金融科技公司，多年来致力于为银行提供Fintech、AI、大数据高性能后端、移动应用程序、数据分析及UX等创新服务，帮助银行推动数字化转型。凭借过去十多年在该领域…"><meta property="og:type" content="article"><meta property="og:title" content="推荐系列-如何使用k3s+树莓派在生产中构建轻量K8S裸机集群"><meta property="og:url" content="https://www.hosiang.cn/9cce842e/index.html"><meta property="og:site_name" content="狂欢马克思"><meta property="og:description" content="&amp;emsp;&amp;emsp;Boogie Software是欧洲著名的金融科技公司，多年来致力于为银行提供Fintech、AI、大数据高性能后端、移动应用程序、数据分析及UX等创新服务，帮助银行推动数字化转型。凭借过去十多年在该领域…"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://oscimg.oschina.net/oscnet/9e0c9d2e8b69df9c13653466ca762eb87e2.jpg"><meta property="og:image" content="https://oscimg.oschina.net/oscnet/9e0c9d2e8b69df9c13653466ca762eb87e2.jpg"><meta property="og:image" content="https://oscimg.oschina.net/oscnet/9e0c9d2e8b69df9c13653466ca762eb87e2.jpg"><meta property="article:published_time" content="2021-04-15T01:19:21.000Z"><meta property="article:modified_time" content="2022-06-23T08:28:47.445Z"><meta property="article:author" content="Howe Hsiang"><meta property="article:tag" content="Popular"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://oscimg.oschina.net/oscnet/9e0c9d2e8b69df9c13653466ca762eb87e2.jpg"><link rel="icon" href="/images/favicon.ico"><link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"><link href="https://cdn.bootcss.com/font-awesome-animation/0.1.0/font-awesome-animation.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/style.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?3cd8fa109426bf3f10bd5c362175bace";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script></script><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><meta name="generator" content="Hexo 6.2.0"></head><script src="/js/jquery.min.js"></script><script src="/js/pace.min.js"></script><script src="/js/crypto-js.js"></script><script src="/js/cookie.js"></script><script src="/js/calendar.js"></script><script src="/js/festival.js"></script><script>getFestival()</script><body><script>window.onload=function(){document.getElementById("TimeShow").innerHTML="本站耗时 "+((new Date).getTime()-start_time)/1e3+" 秒 "}</script><div id="container"><header id="header"><div id="banner"></div><div id="header-outer"><div id="header-menu" class="header-menu-pos animated"><div class="header-menu-container"><a href="/" class="left"><span class="site-title">狂欢马克思</span></a><nav id="header-menu-nav" class="right"><a href="/" rel="external nofollow"><i class="fa fa-home"></i> <span>主页</span> </a><a href="/archives" rel="external nofollow"><i class="fa fa-archive"></i> <span>归档</span> </a><a href="/gitbook" rel="external nofollow"><i class="fa fa-columns"></i> <span>笔记</span> </a><a href="/music" rel="external nofollow"><i class="fa fa-music"></i> <span>音乐</span> </a><a href="/photo" rel="external nofollow"><i class="fa fa-picture-o"></i> <span>相册</span> </a><a href="/love" rel="external nofollow"><i class="fa fa-heart"></i> <span>恋爱</span> </a><a href="/collection" rel="external nofollow"><i class="fa fa-envira"></i> <span>收藏</span> </a><a href="/about" rel="external nofollow"><i class="fa fa-user"></i> <span>关于</span></a></nav><a class="mobile-header-menu-button"><i class="fa fa-bars"></i></a></div></div><div id="header-row"><div id="logo"><a href="/"><img src="/../images/logo.png" alt="logo"></a></div><div class="header-info"><div id="header-title"><h2>狂欢马克思</h2></div><div id="header-description"><h3>专注Web开发</h3></div></div><nav class="header-nav"><div class="social"><a title="Github" target="_blank" href="//github.com/Hosiang1026" rel="external nofollow"><i class="fa fa-github fa-2x"></i></a> <a title="QQ" target="_blank" href="//wpa.qq.com/msgrd?v=3&uin=641904695&site=qq&menu=yes" rel="external nofollow"><i class="fa fa-qq fa-2x"></i></a> <a title="Weibo" target="_blank" href="//www.weibo.com/haoxiang969" rel="external nofollow"><i class="fa fa-weibo fa-2x"></i></a></div></nav></div><script type="text/javascript" src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script><div id="noticeId" class="show" style="background:rgb(244,247,247,.3)"><marquee id="noticeMar" behavior="scoll" class="notice" direction="left" onmouseover="this.stop()" onmouseout="this.start()"></marquee></div><script type="text/javascript">function browserRedirect(){var i=navigator.userAgent.toLowerCase(),n="ipad"==i.match(/ipad/i),e="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),a="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),s="ucweb"==i.match(/ucweb/i),t="android"==i.match(/android/i),r="windows ce"==i.match(/windows ce/i),c="windows mobile"==i.match(/windows mobile/i),d="",m=randomColor(),d=n||e||o||a||s||t||r||c?($("#noticeId").css({"line-height":"1.6em"}),"<font style='color:"+m+"' face='新华宋体'  size='2'>官宣：<span id='msg'></span><span id='timer'></span><span id='jinrishici-sentence'></span></font> "):($("#noticeId").css({"line-height":"3.6em","margin-top":"20px"}),"<font style='color:"+m+"' face='新华宋体'  size='6'>官宣：<span id='weekend'></span><span id='msg'></span><span id='timer'></span><span id='jinrishici-sentence'></span></font> ");$("#noticeMar").html(d)}function randomColor(){for(var i="0,1,2,3,4,5,6,7,8,9,a,b,c,d,e,f".split(","),n="#",e=0;e<6;e++)n+=i[Math.floor(16*Math.random())];return n}$(function(){browserRedirect()})</script></div></header><script>console.log=function(){}</script><div class="outer"><section id="main" class="body-wrap"><article id="post-如何使用k3s+树莓派在生产中构建轻量K8S裸机集群" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 class="post-title" itemprop="name">推荐系列-如何使用k3s+树莓派在生产中构建轻量K8S裸机集群</h1><div class="post-title-bar"><ul><li><i class="fa fa-book"></i> <a href="/categories/热门文章/">热门文章</a></li><li><i class="fa fa-calendar"></i> 2021-04-15</li><li><i class="fa fa-eye"></i> <span id="busuanzi_value_page_pv"></span></li><li><span class="post-count">字数统计: 3.3k字</span></li><li><span class="post-count">阅读时长: 12分钟</span></li></ul></div></header><div class="article-entry post-content" itemprop="articleBody"><p>&amp;emsp;&amp;emsp;Boogie Software是欧洲著名的金融科技公司，多年来致力于为银行提供Fintech、AI、大数据高性能后端、移动应用程序、数据分析及UX等创新服务，帮助银行推动数字化转型。凭借过去十多年在该领域…</p><span id="more"></span><p><img src="https://oscimg.oschina.net/oscnet/9e0c9d2e8b69df9c13653466ca762eb87e2.jpg" alt="Test" title="如何使用k3s+树莓派在生产中构建轻量K8S裸机集群"><br>Boogie Software的IT团队在很多客户银行的核心银行业务数字化的项目中使用到了Kubernetes和容器技术，因此我们��终在想Kubernetes能如何使用更合适的硬件在本地工作。在本文中，我将详细介绍我们如何在树莓派上构建轻量级裸机集群，以在公司网络中运行应用程序和服务。<br>我们之所以这么做，有两个原因：第一，通过建立集群，我们将可以拥有一个平台，来可靠、灵活地运行公司网络内部应用程序和服务；第二，我们可以通过这次机会学习更多关于Kubernetes、微服务以及容器的技能。如果你也想要参照我们的经验来构建一个相似的系统，我建议你至少要了解关于Docker容器、Kubernetes关键概念（节点、pod、服务、deployment等）以及IP网络的基础知识。</p><h3 id="硬件准备"><a href="#硬件准备" class="headerlink" title="硬件准备"></a>硬件准备</h3><p>你需要准备以下设备：</p><p>树莓派2B&#x2F;3B&#x2F;3B+ 的型号，至少一个。你甚至在单个开发板上运行某些应用程序，但是建议使用两个或更多的开发板来分散负载并增加冗余。<br>电源和可用于树莓派的SD卡，现有的以太网交换机或空闲端口以及一些电缆。</p><p>在我们的设置中，我们目前有4个树莓派3代B+开发板，所以在集群中有一个master&#x2F;server和3个代理节点。如果树莓派有外壳当然更好，我们的同事用3d打印机设计了一个。此外，机壳的背面有两个用于冷却的风扇，每个开发板都位于一个托盘上，该托盘可以热插拔以进行维护。这些托盘前面还设有activity&#x2F;heartbeat LED和电源开关的位置，它们都连接到开发板的GPIO接头。<br><img src="https://oscimg.oschina.net/oscnet/9e0c9d2e8b69df9c13653466ca762eb87e2.jpg" alt="Test" title="如何使用k3s+树莓派在生产中构建轻量K8S裸机集群"><br><img src="https://oscimg.oschina.net/oscnet/9e0c9d2e8b69df9c13653466ca762eb87e2.jpg" alt="Test" title="如何使用k3s+树莓派在生产中构建轻量K8S裸机集群"></p><h3 id="软件准备"><a href="#软件准备" class="headerlink" title="软件准备"></a>软件准备</h3><p>对于Kubernetes的实现，我们使用的是k3s。k3s是由Rancher Labs推出的一款轻量级、通过CNCF一致性认证的Kubernetes发行版。尽管这是一款刚推出不久的产品，但它真的十分稳定和易用，可以实现秒级启动。让k3s从其他轻量的Kubernetes发行版脱颖而出的原因是，k3s可供生产使用，而诸如microk8s或Minikube之类的项目则无法实现这一目的，并且k3s十分轻巧，还可以在基于ARM的硬件上很好地运行。在k3s中，任何设备上安装Kubernetes所需的一切都包含在这一个40MB的二进制文件当中。<br>k3s几乎能在任何Linux发行版中很好地运行，因此我们决定将Raspbian Stretch Lite作为基础OS，因为我们不需要在开发板上添加任何额外的服务或者桌面UI。k3s确实需要在Linux内核中启用cgroup，这可以在Raspbian上通过向&#x2F;boot&#x2F;cmdline.txt:添加以下参数来实现：</p><pre><code class="java"> cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory
</code></pre><h3 id="安装k3s"><a href="#安装k3s" class="headerlink" title="安装k3s"></a>安装k3s</h3><p>k3s非常友好的地方在于，它可以实现平滑安装过程。你准备好你的server硬件之后，仅需几分钟就可以完成设置，因为它仅需一行命令就能安装server（主节点）：</p><pre><code class="java"> curl -sfL https://get.k3s.io | sh -
</code></pre><p>代理节点也是如此：</p><pre><code class="java"> curl -sfL https://get.k3s.io | K3S_TOKEN=&lt;token_from_server&gt; K3S_URL=https://&lt;server_ip&gt;:6443 sh -
</code></pre><p>其中token_from_server是来自服务器的文件&#x2F; var &#x2F; lib &#x2F; rancher &#x2F; k3s &#x2F; server &#x2F; node-token的内容，server_ip是服务器节点的IP地址。至此，我们的集群已经启动并正在运行，我们可以开始部署工作负载：</p><pre><code class="java"> root@k3s-server:~# kubectl get nodes
NAME         STATUS   ROLES    AGE    VERSION
k3s-node1    Ready    &lt;none&gt;   40s    v1.13.4-k3s.1
k3s-server   Ready    &lt;none&gt;   108s   v1.13.4-k3s.1
</code></pre><p>为了管理和监控集群，我们安装了Kubernetes Dashboard，它能够提供给非常方便的web界面来查看整个系统的状态、执行管理员操作并访问日志。同时，本地安装和运行kubectl命令也非常有帮助，因为它可以让你从自己的计算机管理集群，而无需ssh进入集群。为此，你只需要安装kubectl，然后将集群信息从服务器节点config &#x2F;etc&#x2F;rancher&#x2F;k3s&#x2F;k3s.yaml复制到本地kubeconfig文件中（通常是${HOME}&#x2F;.kube&#x2F;config）。</p><h3 id="使用负载均衡器暴露服务"><a href="#使用负载均衡器暴露服务" class="headerlink" title="使用负载均衡器暴露服务"></a>使用负载均衡器暴露服务</h3><p>默认情况下，部署在Kubernetes集群上的应用程序仅可以在集群中获取（默认服务类型是ClusterIP）。如果想要从集群外部获取应用程序，有两个选项。你可以使用NodePort类型配置服务，该服务在静态端口的每个节点IP上暴露服务，你也可以使用负载均衡器（服务类型LoadBalancer）。然而，NodePort服务有限制：它们使用自己专用的端口范围，我们只能通过端口号来区分应用。k3s内置了一个简单的负载均衡器，但由于它使用的是节点的IP地址，我们可能很快就会用完IP&#x2F;端口组合并且无法将服务绑定到某个虚拟IP。基于这些原因，我们决定部署MetalLB——一种用于裸机集群的负载均衡器实现。<br>只需应用YAML manifest即可安装MetalLB。在现有网络中运行MetalLB的最简单方法是使用所谓的第2层模式，这意味着集群节点通过ARP协议宣布本地网络中服务的虚拟IP。为此，我们从内部网络保留了一小部分IP地址用于集群服务。MetalLB的配置如下所示：</p><pre><code class="java"> apiVersion: v1
kind: ConfigMap
metadata:
 namespace: metallb-system
 name: config
data:
 config: |
   address-pools:
   - name: company-office
     protocol: layer2
     addresses:
     - 10.10.10.50-10.10.10.99
</code></pre><p>使用此配置，集群服务将被暴露在范围为10.10.10.50—10.10.10.99的地址中。为了绑定服务到指定的IP，你可以在服务清单中使用loadBalancerIP参数：</p><pre><code class="java"> apiVersion: v1
kind: Service
metadata:
 name: my-web-app
spec:
 ports:
 - name: http
   port: 80
   protocol: TCP
   targetPort: 8080
 loadBalancerIP: 10.10.10.51
 selector:
   app: my-web-app
 type: LoadBalancer
</code></pre><p>在负载均衡中，我们面临诸多挑战。例如，Kubernetes中限制在单个负载均衡器中同时使用TCP和UDP端口。要解决这一问题，你可以定义两个服务实例，一个用于TCP端口，另一个用于UDP端口。其缺点是，除非启用IP地址共享，否则你需要在不同的IP地址中运行这两个服务。而且，由于MetalLB是一个年轻项目，因此也存在一些小问题，但我们相信这些很快都会得到解决。</p><h3 id="添加存储"><a href="#添加存储" class="headerlink" title="添加存储"></a>添加存储</h3><p>k3s暂时没有内置的存储解决方案，所以为了使Pod能够访问持久性文件存储，我们需要使用Kubernetes的插件来创建一个。由于Kubernetes的目标之一是使应用程序与基础架构解耦并使其可移植，因此Kubernetes中用PersistentVolume（PV）和PersistentVolumeClaim（PVC）的概念定义了用于存储的抽象层。详细的概念解释可以参照我们之前发过的文章：详解Kubernetes存储关键概念。PV是通常由管理员配置并可供应用程序使用的存储资源。另一方面，PVC描述了应用程序对某种类型和一定数量的存储的需求。创建PVC（通常作为应用程序的一部分）时，如果有一个尚未使用且满足应用程序PVC要求的可用PVC，它将绑定到PV。配置和维护所有这些需要手动工作，因此动态配置卷应运而生。<br>在我们的基础架构中，我们已经有一个现有的NFS服务器，因此我们决定将其用于集群持久性文件存储。在我们的案例中，最简单的方法是使用支持动态配置PV的NFS-Client Provisioner。Provisioner只需在现有的NFS共享上为每个新PV（集群映射到PVC）上创建新目录，然后将PV目录挂载在使用它的容器中。这样就无需配置NFS共享到单个pod中的卷，而是全部动态运行。</p><h3 id="为ARM交叉构建容器镜像"><a href="#为ARM交叉构建容器镜像" class="headerlink" title="为ARM交叉构建容器镜像"></a>为ARM交叉构建容器镜像</h3><p>显然，在基于ARM的硬件上（如树莓派）运行应用程序容器时，需要根据ARM的架构构建容器。在ARM架构容器中构建自己的应用程序时，可能会遇到一些陷阱。首先，基础镜像需要可用于你的目标架构体系。对于树莓派3来说，通常需要使用arm32v7的基础镜像，它们可以在大部分Docker镜像仓库中被调用。所以，当交叉构建应用程序时，确保你的Dockerfile包含以下代码：</p><pre><code class="java"> FROM arm32v7/alpine:latest
</code></pre><p>第二件需要注意的事是，你的主机Docker需要能够运行ARM二进制文件。如果你在mac上运行Docker，那操作将十分轻松，因为它对此有内置支持。如果是在Linux上，你需要执行一些步骤：</p><h4 id="添加QEMU二进制文件到你的基础镜像"><a href="#添加QEMU二进制文件到你的基础镜像" class="headerlink" title="添加QEMU二进制文件到你的基础镜像"></a>添加QEMU二进制文件到你的基础镜像</h4><p>为了在Linux上的Docker中运行ARM二进制文件，镜像需要一个QEMU二进制文件。你可以选择一个已经包含了QEMU二进制文件的基础镜像，也可以在镜像构建过程中复制<br>qemu-arm-static二进制文件到其中，例如，通过将以下行添加到你的Dockerfile中：</p><pre><code class="java"> COPY --from=biarms/qemu-bin /usr/bin/qemu-arm-static /usr/bin/qemu-arm-static
</code></pre><p>然后，你需要在创建Docker镜像的主机OS上注册QEMU。这可以简单地通过以下方式实现：</p><pre><code class="java"> docker run --rm --privileged multiarch/qemu-user-static:register --reset
</code></pre><p>可以在构建实际镜像之前将该命令添加到你的构建脚本中。总结一下，你的Dockerfile.arm应该看起来像这样：</p><pre><code class="java"> FROM arm32v7/alpine:latest
COPY --from=biarms/qemu-bin /usr/bin/qemu-arm-static /usr/bin/qemu-arm-static
# commands to build your app go here…
# e.g. RUN apk add --update &lt;pkgs that you need…&gt;
</code></pre><p>并且你的build &#x2F;CI脚本应该是：</p><pre><code class="java"> docker run --rm --privileged multiarch/qemu-user-static:register --reset
docker build -t my-custom-image-arm . -f Dockerfile.arm
</code></pre><p>这将为你提供ARM架构的容器镜像。如果你对细节很感兴趣，请参阅：<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.ecliptik.com/Cross-Building-and-Running-Multi-Arch-Docker-Images/">https://www.ecliptik.com/Cross-Building-and-Running-Multi-Arch-Docker-Images/</a></p><h3 id="自动化构建和上传到镜像仓库"><a href="#自动化构建和上传到镜像仓库" class="headerlink" title="自动化构建和上传到镜像仓库"></a>自动化构建和上传到镜像仓库</h3><p>最后一步是自动化整个流程，以便容器镜像可以自动构建并且自动上传到一个镜像仓库，在那里可以轻松地将其部署到我们地k3s集群。在内部，我们使用GitLab进行源代码管理和CI&#x2F;CD，因此我们自然希望在其中运行这些构建，它甚至包括一个内置的容器镜像仓库，因此���需要设置单独的镜像仓库。<br>关于构建Docker镜像，GitLab有十分完善的文档（<a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.gitlab.com/ee/ci/docker/using_docker_build.html">https://docs.gitlab.com/ee/ci/docker/using_docker_build.html</a> ） ，因此我们不在此赘述。在为docker构建配置GitLab Runner之后，剩下要做的就是为该项目创建.gitlab-ci.yml文件。在我们的例子中，它看起来像这样：</p><pre><code class="java"> image: docker:stable

stages:
 - build
 - release

variables:
 DOCKER_DRIVER: overlay2
 CONTAINER_TEST_IMAGE: $&#123;CI_REGISTRY_IMAGE&#125;/$&#123;CI_PROJECT_NAME&#125;-arm:$&#123;CI_COMMIT_REF_SLUG&#125;
 CONTAINER_RELEASE_IMAGE: $&#123;CI_REGISTRY_IMAGE&#125;/$&#123;CI_PROJECT_NAME&#125;-arm:latest

before_script:
- docker info
- docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY

build_image:
 stage: build
 script:
   - docker pull $CONTAINER_RELEASE_IMAGE || true
   - docker run --rm --privileged multiarch/qemu-user-static:register --reset
   - docker build --cache-from $CONTAINER_RELEASE_IMAGE -t $CONTAINER_TEST_IMAGE . -f Dockerfile.arm
   - docker push $CONTAINER_TEST_IMAGE

release:
 stage: release
 script:
   - docker pull $CONTAINER_TEST_IMAGE
   - docker tag $CONTAINER_TEST_IMAGE $CONTAINER_RELEASE_IMAGE
   - docker push $CONTAINER_RELEASE_IMAGE
</code></pre><p>既然在容器镜像仓库中我们有了我们的镜像，我们只需要将它们部署到我们的集群中。为了授予集群访问镜像仓库的权限，我们在GitLab中创建了一个deploy令牌，然后将令牌凭据作为docker-registry 密钥添加到集群中：</p><pre><code class="java"> kubectl create secret docker-registry deploycred --docker-server=&lt;your-registry-server&gt; --docker-username=&lt;token-username&gt; --docker-password=&lt;token-password&gt; --docker-email=&lt;your-email&gt;
</code></pre><p>之后，可以在YAML文件PodSpec中使用deploy 令牌密钥：</p><pre><code class="java"> imagePullSecrets:
     - name: deploycred
    containers:
     - name: myapp
       image: gitlab.mycompany.com:4567/my/project/my-app-arm:latest
</code></pre><p>完成所有这些步骤之后，我们终于拥有了一个从私有镜像仓库中的源代码到ARM容器镜像的自动CI &#x2F; CD流水线，可以将其部署到集群中。</p><h3 id="结-语"><a href="#结-语" class="headerlink" title="结 语"></a>结 语</h3><p>总而言之，事实证明，建立和运行自己的裸机Kubernetes集群比预期的要容易。而且k3s确实是在边缘计算场景中和一般配置较低的硬件上运行容器化服务的明智选择。<br>一个小缺点是k3s尚不支持高可用（多主设备配置）。尽管单个主服务器设置已经具有相当的弹性，因为即使主服务器离线，服务仍可在代理节点上继续运行，我们还是希望为主节点提供一些冗余。显然，此功能正在开发中，但在此功能可用之前，我们建议从服务器节点配置中进行备份。</p><div class="post-copyright"><div class="content"><p>本文标题： 推荐系列-如何使用k3s+树莓派在生产中构建轻量K8S裸机集群</p><p>本文作者： OSChina</p><p>发布时间： 2021年04月15日 09:19</p><p>最后更新： 2022年06月23日 16:28</p><p>原始链接： <a class="post-url" href="/9cce842e/" title="推荐系列-如何使用k3s+树莓派在生产中构建轻量K8S裸机集群">https://www.hosiang.cn/9cce842e/</a></p><p>版权声明： 本文著作权归作者所有，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank">CC BY-NC-SA 4.0</a>许可协议，转载请注明出处！</p><footer><a href="https://www.hosiang.cn"><img src="/../images/logo.png" alt="Howe Hsiang"> Howe Hsiang</a></footer></div></div><div class="page-reward"><a id="rewardBtn" href="javascript:;">赏</a></div><div id="reward" class="post-modal reward-lay"><a class="close" href="javascript:;" id="reward-close">×</a> <span class="reward-title"><i class="icon icon-quote-left"></i> 喜欢就赞赏一下呗！ <i class="icon icon-quote-right"></i></span><div class="reward-content"><div class="reward-code"><img id="rewardCode" src="/images/threepay_code.jpg" alt="打赏二维码"></div><div class="reward-select"></div></div></div></div><footer class="article-footer"><div class="post-share"><a href="javascript:" id="share-sub" class="post-share-fab"><i class="fa fa-share-alt" style="padding-top:11px!important"></i></a><div class="post-share-list" id="share-list"><ul class="share-icons"><li><a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://www.hosiang.cn/9cce842e/" data-title="Facebook" rel="external nofollow noopener noreferrer"><i class="fa fa-facebook" style="padding-top:9px!important"></i></a></li><li><a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《推荐系列-如何使用k3s+树莓派在生产中构建轻量K8S裸机集群》 — 狂欢马克思&url=https://www.hosiang.cn/9cce842e/&via=https://www.hosiang.cn" data-title="Twitter" rel="external nofollow noopener noreferrer"><i class="fa fa-twitter" style="padding-top:9px!important"></i></a></li><li><a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://www.hosiang.cn/9cce842e/" data-title="Google+" rel="external nofollow noopener noreferrer"><i class="fa fa-google-plus" style="padding-top:9px!important"></i></a></li><li><a class="qq share-sns" target="_blank" href="https://connect.qq.com/widget/shareqq/index.html?url=https://www.hosiang.cn/9cce842e/&title=《推荐系列-如何使用k3s+树莓派在生产中构建轻量K8S裸机集群》 — 狂欢马克思&source=&amp;emsp;&amp;emsp;Boogie Software是欧洲著名的金融科技公司，多年来致力于为银行提供Fintech、AI、大数据高性能后..." data-title="QQ" rel="external nofollow noopener noreferrer"><i class="fa fa-qq" style="padding-top:9px!important"></i></a></li><li><a class="weixin share-sns" id="wxFab" href="javascript:" data-title="微信"><i class="fa fa-weixin" style="padding-top:9px!important"></i></a></li><li><a class="weibo share-sns" target="_blank" href="https://service.weibo.com/share/share.php?url=https://www.hosiang.cn/9cce842e/&title=《推荐系列-如何使用k3s+树莓派在生产中构建轻量K8S裸机集群》 — 狂欢马克思&pic=https://static.oschina.net/uploads/img/201910/31105553_xgZY.jpg" data-title="微博" rel="external nofollow noopener noreferrer"><i class="fa fa-weibo" style="padding-top:9px!important"></i></a></li></ul></div></div><div class="post-modal wx-share" id="wxShare"><a class="close" href="javascript:" id="wxShare-close">×</a><p>扫一扫，分享到微信</p><img src="//api.qrserver.com/v1/create-qr-code/?data=https://www.hosiang.cn/9cce842e/" alt="微信分享二维码"></div><div class="mask"></div><ul class="article-footer-menu"><li class="article-footer-tags"><i class="fa fa-tags"></i> <a href="/tags/Popular/" class="color3">Popular</a></li></ul></footer></div></article><aside class="post-toc-pos post-toc-top" id="post-toc"><nav class="post-toc-wrap"><ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E7%A1%AC%E4%BB%B6%E5%87%86%E5%A4%87"><span class="post-toc-text">硬件准备</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E8%BD%AF%E4%BB%B6%E5%87%86%E5%A4%87"><span class="post-toc-text">软件准备</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%AE%89%E8%A3%85k3s"><span class="post-toc-text">安装k3s</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E4%BD%BF%E7%94%A8%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%99%A8%E6%9A%B4%E9%9C%B2%E6%9C%8D%E5%8A%A1"><span class="post-toc-text">使用负载均衡器暴露服务</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%B7%BB%E5%8A%A0%E5%AD%98%E5%82%A8"><span class="post-toc-text">添加存储</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E4%B8%BAARM%E4%BA%A4%E5%8F%89%E6%9E%84%E5%BB%BA%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F"><span class="post-toc-text">为ARM交叉构建容器镜像</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E6%B7%BB%E5%8A%A0QEMU%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6%E5%88%B0%E4%BD%A0%E7%9A%84%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F"><span class="post-toc-text">添加QEMU二进制文件到你的基础镜像</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA%E5%92%8C%E4%B8%8A%E4%BC%A0%E5%88%B0%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93"><span class="post-toc-text">自动化构建和上传到镜像仓库</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E7%BB%93-%E8%AF%AD"><span class="post-toc-text">结 语</span></a></li></ol></nav></aside><nav id="article-nav"><a href="/63ea799e/" id="article-nav-newer" class="article-nav-link-wrap"><span class="article-nav-title"><i class="fa fa-hand-o-left" aria-hidden="true"></i> 推荐系列-大规格文件的上传优化 </span></a><a href="/191b12cc/" id="article-nav-older" class="article-nav-link-wrap"><span class="article-nav-title">推荐系列-如何快速安全的插入千万条数据</span> <i class="fa fa-hand-o-right" aria-hidden="true"></i></a></nav><div id="gitalk"></div><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script>var gitalk=new Gitalk({repo:"bolg-comment",owner:"Hosiang1026",admin:"Hosiang1026",clientID:"37a2dd4473e8970cecc2",clientSecret:"e30efa17d86d9de4f4ab810872dc62a7b2e7e634",pagerDirection:"last",distractionFreeMode:!0,createIssueManually:!1});gitalk.render("gitalk")</script></section></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner"><script id="_wau78w">var _wau=_wau||[];_wau.push(["small","5dnguv4c2n","78w"])</script><script async src="//waust.at/s.js"></script><p><span id="busuanzi_container_site_uv" style="display:none"><span class="post-count">总字数：<span>1777.3k</span> </span>总访客数：<span id="busuanzi_value_site_uv"></span> </span><span id="busuanzi_container_site_pv" style="display:none">总访问量：<span id="busuanzi_value_site_pv"></span></span><br><span id="TimeShow">本站</span><span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span><br>Copyright&copy; 2018 - 2022 狂欢马克思 <a href="https://beian.miit.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">京ICP备17060439号</a></p></div></div><script>var now=new Date;function createtime(){var n=new Date("2017/09/18");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="安全运行 "+dnum+" 天 ",document.getElementById("times").innerHTML=hnum+" 小时 "+mnum+" 分 "+snum+" 秒"}setInterval("createtime()",800)</script></footer><script>var mihoConfig={root:"https://www.hosiang.cn",animate:"true",isHome:"false",share:"true",reward:" 1"}</script><div class="sidebar"><div id="sidebar-search" title="Search"><i class="fa fa-search"></i></div><div id="sidebar-category" title="Categories"><i class="fa fa-book"></i></div><div id="sidebar-tag" title="Tags"><i class="fa fa-tags"></i></div><div id="sidebar-top"><span class="sidebar-top-icon"><i class="fa fa-angle-up"></i></span></div></div><div class="sidebar-menu-box" id="sidebar-menu-box"><div class="sidebar-menu-box-container"><div id="sidebar-menu-box-categories"><a class="category-link" href="/categories/%E5%85%B4%E8%B6%A3%E7%88%B1%E5%A5%BD/">兴趣爱好</a><a class="category-link" href="/categories/%E5%85%B6%E4%BB%96%E5%BC%80%E5%8F%91/">其他开发</a><a class="category-link" href="/categories/%E5%89%8D%E6%B2%BF%E5%BC%80%E5%8F%91/">前沿开发</a><a class="category-link" href="/categories/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/">前端开发</a><a class="category-link" href="/categories/%E5%8D%87%E7%BA%A7%E7%89%88%E6%9C%AC/">升级版本</a><a class="category-link" href="/categories/%E5%8D%9A%E5%AE%A2%E6%95%99%E7%A8%8B/">博客教程</a><a class="category-link" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a><a class="category-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a><a class="category-link" href="/categories/%E6%97%A5%E5%B8%B8%E8%AE%B0%E5%BD%95/">日常记录</a><a class="category-link" href="/categories/%E7%83%AD%E9%97%A8%E6%96%87%E7%AB%A0/">热门文章</a></div><div id="sidebar-menu-box-tags"><a href="/tags/Ajax/" style="font-size:10px">Ajax</a> <a href="/tags/AliGenie/" style="font-size:10px">AliGenie</a> <a href="/tags/Alipay/" style="font-size:10px">Alipay</a> <a href="/tags/Android/" style="font-size:10px">Android</a> <a href="/tags/Blockchain/" style="font-size:17.5px">Blockchain</a> <a href="/tags/CQRS/" style="font-size:10px">CQRS</a> <a href="/tags/Database/" style="font-size:15px">Database</a> <a href="/tags/Docker/" style="font-size:10px">Docker</a> <a href="/tags/EasyUI/" style="font-size:10px">EasyUI</a> <a href="/tags/Guitar/" style="font-size:10px">Guitar</a> <a href="/tags/Hackintosh/" style="font-size:12.5px">Hackintosh</a> <a href="/tags/Hexo/" style="font-size:15px">Hexo</a> <a href="/tags/IntelliJ-IDEA/" style="font-size:10px">IntelliJ IDEA</a> <a href="/tags/Java/" style="font-size:12.5px">Java</a> <a href="/tags/Kali-Linux/" style="font-size:10px">Kali Linux</a> <a href="/tags/Life/" style="font-size:17.5px">Life</a> <a href="/tags/Mac-OS/" style="font-size:12.5px">Mac OS</a> <a href="/tags/MultiThread/" style="font-size:10px">MultiThread</a> <a href="/tags/NodeJS/" style="font-size:10px">NodeJS</a> <a href="/tags/Popular/" style="font-size:20px">Popular</a> <a href="/tags/Python/" style="font-size:10px">Python</a> <a href="/tags/SaaS/" style="font-size:10px">SaaS</a> <a href="/tags/Servlet/" style="font-size:10px">Servlet</a> <a href="/tags/Spring/" style="font-size:17.5px">Spring</a> <a href="/tags/Upgrade/" style="font-size:10px">Upgrade</a> <a href="/tags/Web/" style="font-size:10px">Web</a> <a href="/tags/Windows/" style="font-size:10px">Windows</a> <a href="/tags/Work/" style="font-size:10px">Work</a> <a href="/tags/iOS/" style="font-size:10px">iOS</a></div></div><a href="javascript:" class="sidebar-menu-box-close">&times;</a></div><div class="mobile-header-menu-nav" id="mobile-header-menu-nav"><div class="mobile-header-menu-container"><span class="title">导航</span><ul class="mobile-header-menu-navbar"><li><a href="/"><i class="fa fa-home"></i><span>主页</span></a></li><li><a href="/archives"><i class="fa fa-archive"></i><span>归档</span></a></li><li><a href="/gitbook"><i class="fa fa-columns"></i><span>笔记</span></a></li><li><a href="/music"><i class="fa fa-music"></i><span>音乐</span></a></li><li><a href="/photo"><i class="fa fa-picture-o"></i><span>相册</span></a></li><li><a href="/love"><i class="fa fa-heart"></i><span>恋爱</span></a></li><li><a href="/collection"><i class="fa fa-envira"></i><span>收藏</span></a></li><li><a href="/about"><i class="fa fa-user"></i><span>关于</span></a></li></ul></div><div class="mobile-header-tag-container"><span class="title">标签</span><div id="mobile-header-container-tags"><a href="/tags/Ajax/" style="font-size:10px">Ajax</a> <a href="/tags/AliGenie/" style="font-size:10px">AliGenie</a> <a href="/tags/Alipay/" style="font-size:10px">Alipay</a> <a href="/tags/Android/" style="font-size:10px">Android</a> <a href="/tags/Blockchain/" style="font-size:17.5px">Blockchain</a> <a href="/tags/CQRS/" style="font-size:10px">CQRS</a> <a href="/tags/Database/" style="font-size:15px">Database</a> <a href="/tags/Docker/" style="font-size:10px">Docker</a> <a href="/tags/EasyUI/" style="font-size:10px">EasyUI</a> <a href="/tags/Guitar/" style="font-size:10px">Guitar</a> <a href="/tags/Hackintosh/" style="font-size:12.5px">Hackintosh</a> <a href="/tags/Hexo/" style="font-size:15px">Hexo</a> <a href="/tags/IntelliJ-IDEA/" style="font-size:10px">IntelliJ IDEA</a> <a href="/tags/Java/" style="font-size:12.5px">Java</a> <a href="/tags/Kali-Linux/" style="font-size:10px">Kali Linux</a> <a href="/tags/Life/" style="font-size:17.5px">Life</a> <a href="/tags/Mac-OS/" style="font-size:12.5px">Mac OS</a> <a href="/tags/MultiThread/" style="font-size:10px">MultiThread</a> <a href="/tags/NodeJS/" style="font-size:10px">NodeJS</a> <a href="/tags/Popular/" style="font-size:20px">Popular</a> <a href="/tags/Python/" style="font-size:10px">Python</a> <a href="/tags/SaaS/" style="font-size:10px">SaaS</a> <a href="/tags/Servlet/" style="font-size:10px">Servlet</a> <a href="/tags/Spring/" style="font-size:17.5px">Spring</a> <a href="/tags/Upgrade/" style="font-size:10px">Upgrade</a> <a href="/tags/Web/" style="font-size:10px">Web</a> <a href="/tags/Windows/" style="font-size:10px">Windows</a> <a href="/tags/Work/" style="font-size:10px">Work</a> <a href="/tags/iOS/" style="font-size:10px">iOS</a></div></div></div><div class="search-wrap"><span class="search-close">&times;</span> <a href="javascript:" class="header-icon waves-effect waves-circle waves-light" id="back"><i class="icon icon-lg icon-chevron-left"></i> </a><input class="search-field" placeholder="Search..." id="keywords"> <a id="search-submit" href="javascript:"><i class="fa fa-search"></i></a><div class="search-container" id="search-container"><ul class="search-result" id="search-result"></ul></div></div><div id="search-tpl"><li class="search-result-item"><a href="{url}" class="search-item-li"><span class="search-item-li-title" title="{title}">{title}</span></a></li></div><script src="/js/search.js"></script><script src="/js/main.js"></script><script src="//cdn.bootcss.com/particles.js/2.0.0/particles.min.js"></script><div id="particles"></div><script src="/js/particles.js"></script><link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css"><script src="//cdn.bootcss.com/scrollReveal.js/3.0.5/scrollreveal.js"></script><script src="/js/animate.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/hijiki.model.json"},display:{position:"right",width:150,height:300},mobile:{show:!0,scale:.5},log:!1})</script></body></html>