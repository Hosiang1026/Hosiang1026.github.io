---
title: æ¨èç³»åˆ—-NetCoreçš„ç¼“å­˜ä½¿ç”¨è¯¦ä¾‹
categories: çƒ­é—¨æ–‡ç« 
tags:
  - Popular
author: OSChina
top: 2085
cover_picture: 'https://gitee.com/happlyfox/img/raw/master/qrcode_8cm.jpg'
abbrlink: b351a9d2
date: 2021-04-15 09:46:45
---

&emsp;&emsp;å…³äºæˆ‘ ä½œè€…åšå®¢|æ–‡ç« é¦–å‘ ç¼“å­˜åŸºç¡€çŸ¥è¯† ç¼“å­˜å¯ä»¥å‡å°‘ç”Ÿæˆå†…å®¹æ‰€éœ€çš„å·¥ä½œï¼Œä»è€Œæ˜¾è‘—æé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½å’Œå¯ä¼¸ç¼©æ€§ã€‚ ç¼“å­˜æœ€é€‚ç”¨äºä¸ç»å¸¸æ›´æ”¹çš„ æ•°æ®ï¼Œç”Ÿæˆ æˆæœ¬å¾ˆé«˜ã€‚ é€šè¿‡ç¼“å­˜ï¼Œå¯ä»¥æ¯”ä»æ•°æ®...
<!-- more -->

                                                                                                                                                                                        ### å…³äºæˆ‘ 
ä½œè€…åšå®¢|æ–‡ç« é¦–å‘ 
### ç¼“å­˜åŸºç¡€çŸ¥è¯† 
ç¼“å­˜å¯ä»¥å‡å°‘ç”Ÿæˆå†…å®¹æ‰€éœ€çš„å·¥ä½œï¼Œä»è€Œæ˜¾è‘—æé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½å’Œå¯ä¼¸ç¼©æ€§ã€‚ ç¼“å­˜æœ€é€‚ç”¨äºä¸ç»å¸¸æ›´æ”¹çš„ æ•°æ®ï¼Œç”Ÿæˆ æˆæœ¬å¾ˆé«˜ã€‚ é€šè¿‡ç¼“å­˜ï¼Œå¯ä»¥æ¯”ä»æ•°æ®æºè¿”å›çš„æ•°æ®çš„å‰¯æœ¬é€Ÿåº¦å¿«å¾—å¤šã€‚ åº”è¯¥å¯¹åº”ç”¨è¿›è¡Œç¼–å†™å’Œæµ‹è¯•ï¼Œä½¿å…¶ æ°¸ä¸ ä¾èµ–äºç¼“å­˜çš„æ•°æ®ã€‚ 
ASP.NET Core æ”¯æŒå¤šä¸ªä¸åŒçš„ç¼“å­˜ã€‚ æœ€ç®€å•çš„ç¼“å­˜åŸºäº IMemoryCacheã€‚  
 ```java 
  IMemoryCache
  ``` 
  è¡¨ç¤ºå­˜å‚¨åœ¨ web æœåŠ¡å™¨çš„å†…å­˜ä¸­çš„ç¼“å­˜ã€‚ åœ¨æœåŠ¡å™¨åœºä¸Šè¿è¡Œçš„åº”ç”¨ (å¤šå°æœåŠ¡å™¨) åº”ç¡®ä¿ä¼šè¯åœ¨ä½¿ç”¨å†…å­˜ä¸­ç¼“å­˜æ—¶å¤„äºç²˜æ»çŠ¶æ€ã€‚ ç²˜æ»ä¼šè¯ç¡®ä¿æ¥è‡ªå®¢æˆ·ç«¯çš„åç»­è¯·æ±‚éƒ½å°†å‘é€åˆ°ç›¸åŒçš„æœåŠ¡å™¨ã€‚ 
å†…å­˜ä¸­ç¼“å­˜å¯ä»¥å­˜å‚¨ä»»ä½•å¯¹è±¡ã€‚ åˆ†å¸ƒå¼ç¼“å­˜æ¥å£ä»…é™  
 ```java 
  byte[]
  ``` 
  ã€‚ å†…å­˜ä¸­å’Œåˆ†å¸ƒå¼ç¼“å­˜å°†ç¼“å­˜é¡¹ä½œä¸ºé”®å€¼å¯¹ã€‚ 
### ç¼“å­˜æŒ‡å— 
 
 ä»£ç åº”å§‹ç»ˆå…·æœ‰å›é€€é€‰é¡¹ï¼Œä»¥è·å–æ•°æ®ï¼Œè€Œ ä¸æ˜¯ä¾èµ–äºå¯ç”¨çš„ç¼“å­˜å€¼ã€‚ 
 ç¼“å­˜ä½¿ç”¨ç¨€æœ‰èµ„æºå†…å­˜,é™åˆ¶ç¼“å­˜å¢é•¿ï¼š 
   
   ä¸è¦ ä½¿ç”¨å¤–éƒ¨ è¾“å…¥ä½œä¸ºç¼“å­˜é”®ã€‚ 
   ä½¿ç”¨è¿‡æœŸé™åˆ¶ç¼“å­˜å¢é•¿ã€‚ 
   ä½¿ç”¨ SetSizeã€Size å’Œ SizeLimit é™åˆ¶ç¼“å­˜å¤§å°]ã€‚ ASP.NET Core è¿è¡Œæ—¶ä¸ä¼šæ ¹æ®å†…å­˜ å‹åŠ›é™åˆ¶ç¼“å­˜ å¤§å°ã€‚ å¼€å‘äººå‘˜éœ€è¦é™åˆ¶ç¼“å­˜å¤§å°ã€‚ 
    
 
### ä½¿ç”¨ 
#### DIæ³¨å…¥ 
åˆ›å»ºä¸€ä¸ªNetCoreæ§åˆ¶å°é¡¹ç›®ï¼Œè¿›è¡Œç¼“å­˜çš„é¡¹ç›®æ¼”ç¤ºã€‚ 
æ§åˆ¶å°é¡¹ç›®åªæœ‰ä¸€ä¸ªåˆå§‹åŒ–çš„Program.csæ–‡ä»¶ã€‚åŸºäºNetCoreè¿›è¡Œé¡¹ç›®ç¼–ç ï¼Œæ¯ä¸€æ­¥å°±æ˜¯åˆ›å»ºä¸€ä¸ªåŸºç¡€æ¨¡æ¿ï¼Œä½¿ç”¨ä¾èµ–æ³¨å…¥çš„æ–¹å¼ã€‚ 
 
 ```java 
  nuget install Microsoft.Extensions.Hosting

  ``` 
  
 
 ```java 
    public static class Program
    {
        static async void Main(string[] args)
        {
           var builder = new HostBuilder().ConfigureServices((context, service) =>
            {

            });

           await builder.RunConsoleAsync();
        }
    }

  ``` 
  
æ³¨å…¥ç¼“å­˜æœåŠ¡,æ§åˆ¶å°éœ€è¦ä¸‹è½½åº“ Microsoft.Extensions.Caching.Memory 
 
 ```java 
  nuget install Microsoft.Extensions.Caching.Memory

  ``` 
  
 
 ```java 
    public static class Program
    {
        static async void Main(string[] args)
        {
           var builder = new HostBuilder().ConfigureServices((context, service) =>
            {
      		  service.AddMemoryCache();
      		  
              service.AddScoped<CacheService>();//å®é™…æµ‹è¯•æœåŠ¡

              service.AddHostedService<BackgroundJob>();//åå°æ‰§è¡Œæ–¹æ³•
            });

           await builder.RunConsoleAsync();
        }
    }

  ``` 
  
åå°æœåŠ¡ 
 
 ```java 
  public class BackgroundJob : IHostedService
    {
        private readonly CacheService _cacheService;

        public BackgroundJob(CacheService cacheService)
        {
            _cacheService = cacheService;
        }

        public Task StartAsync(CancellationToken cancellationToken)
        {
            _cacheService.Action();

            return Task.CompletedTask;
        }

        public Task StopAsync(CancellationToken cancellationToken)
        {
            return Task.CompletedTask;
        }
    }

  ``` 
  
#### MemoryCacheä½¿ç”¨æ€»ç»“ 
é€šè¿‡æ„é€ å‡½æ•°è‡ªåŠ¨æ³¨å…¥IMemoryCache 
 
 ```java 
  public class CacheService
{
    private readonly IMemoryCache _memoryCache;

    public CacheService(IMemoryCache memoryCache)
    {
   		 _memoryCache = memoryCache;
    }
}

  ``` 
  
#### æœ€åŸºæœ¬çš„ä½¿ç”¨ 
Setæ–¹æ³•æ ¹æ®Keyè®¾ç½®ç¼“å­˜ï¼Œé»˜è®¤ç¼“å­˜ä¸è¿‡æœŸ 
Getæ–¹æ³•æ ¹æ®Keyå–å‡ºç¼“å­˜ 
 
 ```java 
  /// <summary>
/// ç¼“å­˜è®¾ç½®
/// </summary>
public void BaseCache()
{
    string cacheKey = "timestamp";
    //set cache
    _memoryCache.Set(cacheKey, DateTime.Now.ToString());

    //get cache
    Console.WriteLine(_memoryCache.Get(cacheKey));
}

  ``` 
  
IMemoryCacheæä¾›ä¸€äº›å¥½çš„è¯­æ³•ç³–ä¾›å¼€å‘è€…ä½¿ç”¨ï¼Œå…·ä½“å†…å®¹çœ‹ä¸‹æ–¹æ–‡æ¡£ 
 
 ```java 
  /// <summary>
/// ç‰¹æ®Šæ–¹æ³•çš„ä½¿ç”¨
/// </summary>
public void ActionUse()
{
    //åœºæ™¯-å¦‚æœç¼“å­˜å­˜åœ¨ï¼Œå–å‡ºã€‚å¦‚æœç¼“å­˜ä¸å­˜åœ¨ï¼Œå†™å…¥
    //åŸå§‹å†™æ³•
    string cacheKey = "timestamp";
    if (_memoryCache.Get(cacheKey) != null)
    {
        _memoryCache.Set(cacheKey, DateTime.Now.ToString());
    }
    else
    {
        Console.WriteLine(_memoryCache.Get(cacheKey));
    }

    //æ–°å†™æ³•
    var dataCacheValue = _memoryCache.GetOrCreate(cacheKey, entry =>
     {
         return DateTime.Now.ToString();
     });
    Console.WriteLine(dataCacheValue);

    //åˆ é™¤ç¼“å­˜
    _memoryCache.Remove(cacheKey);

    //åœºæ™¯ åˆ¤æ–­ç¼“å­˜æ˜¯å¦å­˜åœ¨çš„åŒæ—¶å–å‡ºç¼“å­˜æ•°æ®
    _memoryCache.TryGetValue(cacheKey, out string cacheValue);
    Console.WriteLine(cacheValue);

}

  ``` 
  
##### ç¼“å­˜è¿‡æœŸç­–ç•¥ 
è®¾ç½®ç¼“å­˜å¸¸ç”¨çš„æ–¹å¼ä¸»è¦æ˜¯ä»¥ä¸‹äºŒç§ 
 
 ç»å¯¹åˆ°æœŸï¼ˆæŒ‡å®šåœ¨ä¸€ä¸ªå›ºå®šçš„æ—¶é—´ç‚¹åˆ°æœŸï¼‰ 
 æ»‘åŠ¨åˆ°æœŸï¼ˆåœ¨ä¸€ä¸ªæ—¶é—´é•¿åº¦å†…æ²¡æœ‰è¢«å‘½ä¸­åˆ™è¿‡æœŸï¼‰ 
 ç»„åˆè¿‡æœŸ (ç»å¯¹è¿‡æœŸ+æ»‘åŠ¨è¿‡æœŸï¼‰ 
 
###### ç»å¯¹åˆ°æœŸ 
è¿‡æœŸç­–ç•¥ 5ç§’åè¿‡æœŸ 
 
 ```java 
  //set absolute cache
string cacheKey = "absoluteKey";
_memoryCache.Set(cacheKey, DateTime.Now.ToString(), TimeSpan.FromSeconds(5));

//get absolute cache
for (int i = 0; i < 6; i++)
{
    Console.WriteLine(_memoryCache.Get(cacheKey));
    Thread.Sleep(1000);
}

  ``` 
  
###### æ»‘åŠ¨åˆ°æœŸ 
è¿‡æœŸç­–ç•¥ 2ç§’çš„æ»‘åŠ¨è¿‡æœŸæ—¶é—´ï¼Œå¦‚æœ2ç§’å†…æœ‰è®¿é—®ï¼Œè¿‡æœŸæ—¶é—´å»¶åã€‚å½“2ç§’çš„åŒºé—´å†…æ²¡æœ‰è®¿é—®ï¼Œç¼“å­˜è¿‡æœŸ 
 
 ```java 
  //set slibing cache
string cacheSlibingKey = "slibingKey";
MemoryCacheEntryOptions options = new MemoryCacheEntryOptions();
options.SlidingExpiration = TimeSpan.FromSeconds(2);

_memoryCache.Set(cacheSlibingKey, DateTime.Now.ToString(), options);

//get slibing cache
for (int i = 0; i < 2; i++)
{
    Console.WriteLine(_memoryCache.Get(cacheSlibingKey));
    Thread.Sleep(1000);
}
for (int i = 0; i < 2; i++)
{
    Thread.Sleep(2000);
    Console.WriteLine(_memoryCache.Get(cacheSlibingKey));
}

  ``` 
  
###### ç»„åˆè¿‡æœŸ 
è¿‡æœŸç­–ç•¥ 
6ç§’ç»å¯¹è¿‡æœŸ+2ç§’æ»‘åŠ¨è¿‡æœŸ 
æ»¡è¶³ä»»æ„ä¸€ä¸ªç¼“å­˜éƒ½å°†å¤±æ•ˆ 
 
 ```java 
  string cacheCombineKey = "combineKey";
MemoryCacheEntryOptions combineOptions = new MemoryCacheEntryOptions();
combineOptions.SlidingExpiration = TimeSpan.FromSeconds(2);
combineOptions.AbsoluteExpiration = DateTime.Now.AddSeconds(6);

_memoryCache.Set(cacheCombineKey, DateTime.Now.ToString(), combineOptions);

//get slibing cache
for (int i = 0; i < 2; i++)
{
    Console.WriteLine(_memoryCache.Get(cacheCombineKey));
    Thread.Sleep(1000);
}

for (int i = 0; i < 6; i++)
{
    Thread.Sleep(2000);
    Console.WriteLine(i+"|" + _memoryCache.Get(cacheCombineKey));
}

Console.WriteLine("------------combineKey End----------------");

  ``` 
  
#### ç¼“å­˜çŠ¶æ€å˜åŒ–äº‹ä»¶ 
å½“ç¼“å­˜æ›´æ–°ã€åˆ é™¤æ—¶è§¦å‘ä¸€ä¸ªå›è°ƒäº‹ä»¶ï¼Œè®°å½•ç¼“å­˜å˜åŒ–çš„å†…å®¹ã€‚ 
 
 ```java 
  /// <summary>
/// cacheçŠ¶æ€å˜åŒ–å›è°ƒ
/// </summary>
public void CacheStateCallback()
{
    MemoryCacheEntryOptions options = new MemoryCacheEntryOptions();
    options.AbsoluteExpiration = DateTime.Now.AddSeconds(3
        );
    options.RegisterPostEvictionCallback(MyCallback, this);

    //show callback console
    string cacheKey = "absoluteKey";
    _memoryCache.Set(cacheKey, DateTime.Now.ToString(), options);

    Thread.Sleep(500);
    _memoryCache.Set(cacheKey, DateTime.Now.ToString(), options);

    _memoryCache.Remove(cacheKey);

}

private static void MyCallback(object key, object value, EvictionReason reason, object state)
{
    var message = $"Cache entry state change:{key} {value} {reason} {state}";
    ((CacheService)state)._memoryCache.Set("callbackMessage", message);

    Console.WriteLine(message);
}

  ``` 
  
#### ç¼“å­˜ä¾èµ–ç­–ç•¥ 
 
 
 ```java 
  /// <summary>
/// ç¼“å­˜ä¾èµ–ç­–ç•¥
/// </summary>
public void CacheDependencyPolicy()
{
    string DependentCTS = "DependentCTS";
    string cacheKeyParent = "CacheKeys.Parent";
    string cacheKeyChild = "CacheKeys.Child";

    var cts = new CancellationTokenSource();
    _memoryCache.Set(DependentCTS, cts);

    //åˆ›å»ºä¸€ä¸ªcacheç­–ç•¥
    using (var entry = _memoryCache.CreateEntry(cacheKeyParent))
    {
        //å½“å‰keyå¯¹åº”çš„å€¼
        entry.Value = "parent" + DateTime.Now;

        //å½“å‰keyå¯¹åº”çš„å›è°ƒäº‹ä»¶
        entry.RegisterPostEvictionCallback(MyCallback, this);

        //åŸºäºäº›keyåˆ›å»ºä¸€ä¸ªä¾èµ–ç¼“å­˜
        _memoryCache.Set(cacheKeyChild, "child" + DateTime.Now, new CancellationChangeToken(cts.Token));
    }

    string ParentCachedTime = _memoryCache.Get<string>(cacheKeyParent);
    string ChildCachedTime = _memoryCache.Get<string>(cacheKeyChild);
    string callBackMsg = _memoryCache.Get<string>("callbackMessage");
    Console.WriteLine("ç¬¬ä¸€æ¬¡è·å–");
    Console.WriteLine(ParentCachedTime + "|" + ChildCachedTime + "|" + callBackMsg);

    //ç§»é™¤parentKey
    _memoryCache.Get<CancellationTokenSource>(DependentCTS).Cancel();
    Thread.Sleep(1000);

    ParentCachedTime = _memoryCache.Get<string>(cacheKeyParent);
    ChildCachedTime = _memoryCache.Get<string>(cacheKeyChild);
    callBackMsg = _memoryCache.Get<string>("callbackMessage");
    Console.WriteLine("ç¬¬äºŒæ¬¡è·å–");
    Console.WriteLine(ParentCachedTime + "|" + ChildCachedTime + "|" + callBackMsg);
}

  ``` 
  
### å‚è€ƒèµ„æ–™ 
AspNetCoreä¸­çš„ç¼“å­˜å†…å­˜ 
.NetCoreç¼“å­˜ç¯‡ä¹‹MemoryCache 
Asp.Net Core è½»æ¾å­¦-åœ¨.Net Core ä½¿ç”¨ç¼“å­˜å’Œé…ç½®ä¾èµ–ç­–ç•¥ 
æ‹¥æŠ±.NET Coreç³»åˆ—ï¼šMemoryCache ç¼“å­˜è¿‡æœŸ 
æ¨èé˜…è¯» 
Redisï¿½ï¿½å…·æ”¶è´¹åæ–°çš„å¼€æºå·²å‡ºç° 
GitHubä¸ŠStaræœ€é«˜çš„å·¥ç¨‹å¸ˆæŠ€èƒ½å›¾è°± 
ä¸­å›½ç¨‹åºå‘˜æœ€å®¹æ˜“å‘é”™çš„å•è¯  
æ¨è!!! Markdownå›¾æ ‡ç´¢å¼•ç½‘ç«™ 
### æœ€å 
æœ¬æ–‡åˆ°æ­¤ç»“æŸï¼Œå¸Œæœ›å¯¹ä½ æœ‰å¸®åŠ© ğŸ˜ƒ 
å¦‚æœè¿˜æœ‰ä»€ä¹ˆç–‘é—®æˆ–è€…å»ºè®®ï¼Œå¯ä»¥å¤šå¤šäº¤æµï¼ŒåŸåˆ›æ–‡ç« ï¼Œæ–‡ç¬”æœ‰é™ï¼Œæ‰ç–å­¦æµ…ï¼Œæ–‡ä¸­è‹¥æœ‰ä¸æ­£ä¹‹å¤„ï¼Œä¸‡æœ›å‘ŠçŸ¥ã€‚ 
æ›´å¤šç²¾å½©æŠ€æœ¯æ–‡ç« æ±‡æ€»åœ¨æˆ‘çš„ å…¬ä¼—å·ã€ç¨‹åºå‘˜å·¥å…·é›†ã€‘ï¼ŒæŒç»­æ›´æ–°ï¼Œæ¬¢è¿å…³æ³¨è®¢é˜…æ”¶è—ã€‚ 
![Test](https://gitee.com/happlyfox/img/raw/master/qrcode_8cm.jpg  'NetCoreçš„ç¼“å­˜ä½¿ç”¨è¯¦ä¾‹')
                                        